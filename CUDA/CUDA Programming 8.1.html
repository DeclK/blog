<!DOCTYPE html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=DeclK><link rel=canonical href=https://declk.github.io/blog/CUDA/CUDA%20Programming%208.1.html><link rel=prev href=index.html><link rel=alternate type=application/rss+xml title="RSS feed" href=../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="RSS feed of updated content" href=../feed_rss_updated.xml><link rel=icon href=../img/declk.jpg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.0"><title>CUDA Programming 8.1 - DeclK's Blog</title><link rel=stylesheet href=../assets/stylesheets/main.618322db.min.css><link rel=stylesheet href=../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=JetBrains+Mono:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"JetBrains Mono";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css><link rel=stylesheet href=../css/custom.css><link rel=stylesheet href=../css/card.css><link rel=stylesheet href=../css/flink.css><link rel=stylesheet href=../css/tasklist.css><link rel=stylesheet href=../css/footer-stats.css><link rel=stylesheet href=../css/mathjax.css><link rel=stylesheet href=../css/markdown.css><link rel=stylesheet href=../assets/document_dates/fonts/material-icons.css><link rel=stylesheet href=../assets/document_dates/tippy/light.css><link rel=stylesheet href=../assets/document_dates/tippy/material.css><link rel=stylesheet href=../assets/document_dates/tippy/shift-away.css><link rel=stylesheet href=../assets/document_dates/tippy/scale.css><link rel=stylesheet href=../assets/document_dates/tippy/backdrop.css><link rel=stylesheet href=../assets/document_dates/tippy/tippy.css><link rel=stylesheet href=../assets/document_dates/core/core.css><link rel=stylesheet href=../assets/document_dates/user.config.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-NKJWZM1JHX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-NKJWZM1JHX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-NKJWZM1JHX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link href=../assets/stylesheets/glightbox.min.css rel=stylesheet><script src=../assets/javascripts/glightbox.min.js></script><style id=glightbox-style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#cuda-programming-81 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <!--
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Determine classes --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <!-- Link to home --> <a href=.. title="DeclK's Blog" class="md-header__button md-logo" aria-label="DeclK's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M23 18H1l7.25-9.67 2 2.67L14 6zm-11.5-5.33L14 16h5l-5-6.67zM5 16h6.5l-3.25-4.33z"></path></svg> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> <a href=.. title="DeclK's Blog" aria-label="DeclK's Blog"> DeclK's Blog </a> </span> </div> <div class=md-header__topic> <span class=md-ellipsis> <a href=.. title="DeclK's Blog" aria-label="DeclK's Blog"> DeclK's Blog </a> </span> </div> </div> </div> <!-- About Me link --> <a href=../about.html title="About Me" class=md-source aria-label="About Me" data-md-component=about> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13M6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75M8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2"></path></svg> </div> <div class=md-source__repository> </div> </a> <!-- Color palette toggle --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=indigo aria-label="light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=teal aria-label="dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <!-- User preference: color palette --> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <!-- Site language selector --> <!-- Button to open search modal --> <!-- Check if search is actually enabled - see https://t.ly/DT_0V --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/declk/blog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class=md-source__repository> Blog GitHub </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../index.html class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg> Home </a> </li> <li class=md-tabs__item> <a href=../LLMs/index.html class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2M6 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m12 12c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2"></path></svg> LLMs </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=index.html class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2M6 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m12 12c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2"></path></svg> CUDA </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=/ title="DeclK's Blog" class="md-nav__button md-logo" aria-label="DeclK's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M23 18H1l7.25-9.67 2 2.67L14 6zm-11.5-5.33L14 16h5l-5-6.67zM5 16h6.5l-3.25-4.33z"></path></svg> </a> DeclK's Blog </label> <div class=md-nav__source> <a href=https://github.com/declk/blog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class=md-source__repository> Blog GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__container"> <a href=../LLMs/index.html class="md-nav__link "> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2M6 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m12 12c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2"></path></svg> <span class=md-ellipsis> LLMs </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> LLMs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../LLMs/GPTQ.html class=md-nav__link> <span class=md-ellipsis> GPTQ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__container"> <a href=index.html class="md-nav__link "> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2M6 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m12 12c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2"></path></svg> <span class=md-ellipsis> CUDA </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> CUDA </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> CUDA Programming 8.1 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=CUDA%20Programming%208.1.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> CUDA Programming 8.1 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 核心抽象 </span> </a> <nav class=md-nav aria-label=核心抽象> <ul class=md-nav__list> <li class=md-nav__item> <a href=#layout-algebra class=md-nav__link> <span class=md-ellipsis> Layout Algebra </span> </a> <nav class=md-nav aria-label="Layout Algebra"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 基本概念 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 基本运算 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 组合运算 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mma class=md-nav__link> <span class=md-ellipsis> MMA </span> </a> <nav class=md-nav aria-label=MMA> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mma-atom class=md-nav__link> <span class=md-ellipsis> MMA Atom </span> </a> </li> <li class=md-nav__item> <a href=#tiledmma class=md-nav__link> <span class=md-ellipsis> TiledMMA </span> </a> </li> <li class=md-nav__item> <a href=#thrmma class=md-nav__link> <span class=md-ellipsis> ThrMMA </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#copy class=md-nav__link> <span class=md-ellipsis> Copy </span> </a> <nav class=md-nav aria-label=Copy> <ul class=md-nav__list> <li class=md-nav__item> <a href=#copy-atom class=md-nav__link> <span class=md-ellipsis> Copy Atom </span> </a> </li> <li class=md-nav__item> <a href=#tiledcopy class=md-nav__link> <span class=md-ellipsis> TiledCopy </span> </a> </li> <li class=md-nav__item> <a href=#thrcopy class=md-nav__link> <span class=md-ellipsis> ThrCopy </span> </a> </li> <li class=md-nav__item> <a href=#ldmatrix class=md-nav__link> <span class=md-ellipsis> ldmatrix </span> </a> </li> <li class=md-nav__item> <a href=#how-to-build class=md-nav__link> <span class=md-ellipsis> How to build? </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 重要补充材料 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 核心优化 </span> </a> <nav class=md-nav aria-label=核心优化> <ul class=md-nav__list> <li class=md-nav__item> <a href=#double-buffer class=md-nav__link> <span class=md-ellipsis> 多级流水线 (Double Buffer) </span> </a> </li> <li class=md-nav__item> <a href=#swizzle class=md-nav__link> <span class=md-ellipsis> Swizzle </span> </a> <nav class=md-nav aria-label=Swizzle> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bank-conflict class=md-nav__link> <span class=md-ellipsis> Bank Conflict </span> </a> </li> <li class=md-nav__item> <a href=#swizzle-in-bits class=md-nav__link> <span class=md-ellipsis> Swizzle in Bits </span> </a> </li> <li class=md-nav__item> <a href=#introduce-examples class=md-nav__link> <span class=md-ellipsis> Introduce Examples </span> </a> </li> <li class=md-nav__item> <a href=#logical-physical-view class=md-nav__link> <span class=md-ellipsis> Logical &amp; Physical view </span> </a> </li> <li class=md-nav__item> <a href=#general-methods class=md-nav__link> <span class=md-ellipsis> General Methods </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#epilogue class=md-nav__link> <span class=md-ellipsis> Epilogue </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#hgemm class=md-nav__link> <span class=md-ellipsis> hgemm 实践 </span> </a> <nav class=md-nav aria-label="hgemm 实践"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#define-tile class=md-nav__link> <span class=md-ellipsis> Define tile </span> </a> </li> <li class=md-nav__item> <a href=#define-smem class=md-nav__link> <span class=md-ellipsis> Define smem </span> </a> </li> <li class=md-nav__item> <a href=#pipelines class=md-nav__link> <span class=md-ellipsis> Pipelines </span> </a> </li> <li class=md-nav__item> <a href=#pseudo-code class=md-nav__link> <span class=md-ellipsis> Pseudo code </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 总结 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 核心抽象 </span> </a> <nav class=md-nav aria-label=核心抽象> <ul class=md-nav__list> <li class=md-nav__item> <a href=#layout-algebra class=md-nav__link> <span class=md-ellipsis> Layout Algebra </span> </a> <nav class=md-nav aria-label="Layout Algebra"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 基本概念 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 基本运算 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 组合运算 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mma class=md-nav__link> <span class=md-ellipsis> MMA </span> </a> <nav class=md-nav aria-label=MMA> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mma-atom class=md-nav__link> <span class=md-ellipsis> MMA Atom </span> </a> </li> <li class=md-nav__item> <a href=#tiledmma class=md-nav__link> <span class=md-ellipsis> TiledMMA </span> </a> </li> <li class=md-nav__item> <a href=#thrmma class=md-nav__link> <span class=md-ellipsis> ThrMMA </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#copy class=md-nav__link> <span class=md-ellipsis> Copy </span> </a> <nav class=md-nav aria-label=Copy> <ul class=md-nav__list> <li class=md-nav__item> <a href=#copy-atom class=md-nav__link> <span class=md-ellipsis> Copy Atom </span> </a> </li> <li class=md-nav__item> <a href=#tiledcopy class=md-nav__link> <span class=md-ellipsis> TiledCopy </span> </a> </li> <li class=md-nav__item> <a href=#thrcopy class=md-nav__link> <span class=md-ellipsis> ThrCopy </span> </a> </li> <li class=md-nav__item> <a href=#ldmatrix class=md-nav__link> <span class=md-ellipsis> ldmatrix </span> </a> </li> <li class=md-nav__item> <a href=#how-to-build class=md-nav__link> <span class=md-ellipsis> How to build? </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 重要补充材料 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 核心优化 </span> </a> <nav class=md-nav aria-label=核心优化> <ul class=md-nav__list> <li class=md-nav__item> <a href=#double-buffer class=md-nav__link> <span class=md-ellipsis> 多级流水线 (Double Buffer) </span> </a> </li> <li class=md-nav__item> <a href=#swizzle class=md-nav__link> <span class=md-ellipsis> Swizzle </span> </a> <nav class=md-nav aria-label=Swizzle> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bank-conflict class=md-nav__link> <span class=md-ellipsis> Bank Conflict </span> </a> </li> <li class=md-nav__item> <a href=#swizzle-in-bits class=md-nav__link> <span class=md-ellipsis> Swizzle in Bits </span> </a> </li> <li class=md-nav__item> <a href=#introduce-examples class=md-nav__link> <span class=md-ellipsis> Introduce Examples </span> </a> </li> <li class=md-nav__item> <a href=#logical-physical-view class=md-nav__link> <span class=md-ellipsis> Logical &amp; Physical view </span> </a> </li> <li class=md-nav__item> <a href=#general-methods class=md-nav__link> <span class=md-ellipsis> General Methods </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#epilogue class=md-nav__link> <span class=md-ellipsis> Epilogue </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#hgemm class=md-nav__link> <span class=md-ellipsis> hgemm 实践 </span> </a> <nav class=md-nav aria-label="hgemm 实践"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#define-tile class=md-nav__link> <span class=md-ellipsis> Define tile </span> </a> </li> <li class=md-nav__item> <a href=#define-smem class=md-nav__link> <span class=md-ellipsis> Define smem </span> </a> </li> <li class=md-nav__item> <a href=#pipelines class=md-nav__link> <span class=md-ellipsis> Pipelines </span> </a> </li> <li class=md-nav__item> <a href=#pseudo-code class=md-nav__link> <span class=md-ellipsis> Pseudo code </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 总结 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../index.html class=md-path__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-path__item> <a href=index.html class=md-path__link> <span class=md-ellipsis> CUDA </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=cuda-programming-81>CUDA Programming 8.1<a class=headerlink href=#cuda-programming-81 title="Permanent link">¶</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"></path></svg></span> 约 16223 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M360.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m64.6 136.1c-12.5 12.5-12.5 32.8 0 45.3l73.4 73.4-73.4 73.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l96-96c12.5-12.5 12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0zm-274.7 0c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l73.3-73.4c12.5-12.5 12.5-32.8 0-45.3z"></path></svg></span> 372 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"></path></svg></span> 16 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"></path></svg></span> 预计阅读时间 86 分钟</p> </div> <div class="document-dates-plugin-wrapper document-dates-top"><div class=document-dates-plugin locale><span data-tippy-content data-tippy-raw=2025-12-08><span class=material-icons data-icon=doc_created></span><time datetime=2025-12-08T00:38:08+08:00>2025-12-08</time></span><span data-tippy-content data-tippy-raw=2025-12-09><span class=material-icons data-icon=doc_updated></span><time datetime=2025-12-09T14:01:19+00:00>2025-12-09</time></span><span class=material-icons data-icon=doc_author></span><div class=avatar-group><div class=avatar-wrapper data-name=DeclK data-tippy-content data-tippy-raw='<a href="mailto:1605224559@qq.com">DeclK</a>'><span class=avatar-text></span><a class=glightbox data-type=image data-width=80% data-height=auto href=https://avatars.githubusercontent.com/declk data-desc-position=bottom><img class=avatar src=https://avatars.githubusercontent.com/declk onerror="this.style.display='none'"></a></div></div></div></div> <p>我自己写了一系列的 CUDA 笔记，没有发在博客当中，这篇笔记是我将之前的 CUDA Programming 7 &amp; 8 进行一个综合整理，所以将该笔记命名为 8.1。该笔记包含了对 cute layout algebra 的学习，以及如何在 sm80 上完成高性能 GEMM 运算。友情提示：内容相当丰富，阅读需要相当强的耐心</p> <h2 id=_1>核心抽象<a class=headerlink href=#_1 title="Permanent link">¶</a></h2> <h3 id=layout-algebra>Layout Algebra<a class=headerlink href=#layout-algebra title="Permanent link">¶</a></h3> <p>这是整个 cute 的核心，并且 cute 本身文档很难读，而且网上没有太多的学习资料，所以就算是 GPT 也很难给出好的回答。我的学习资料主要来源于三个部分：1. Reed zhihu 2. <a href=https://leimao.github.io/article/CuTe-Layout-Algebra/ >Lei Mao's blog</a> 3. <a href=https://research.colfax-intl.com/a-note-on-the-algebra-of-cute-layouts/ >A note on the algebra of CuTe Layouts</a></p> <p>我想以四个部分来介绍，目的是为了形成对 layout algebra 的清晰理解，使得我在阅读代码的时候能够进行逻辑推理</p> <ol> <li>layout 基本概念</li> <li>layout algebra 基本运算</li> <li>layout algebra 组合运算</li> <li>layout algebra 直观总结</li> </ol> <h4 id=_2>基本概念<a class=headerlink href=#_2 title="Permanent link">¶</a></h4> <p>layout 概念非常简单，就是由两部分组成：shape &amp; stride，二者共同构建出一个整数到整数的映射：<span class=arithmatex>\(\mathbb{N} \rightarrow \mathbb{N}\)</span></p> <div class=arithmatex>\[ shape=(s_0,s_1,...,s_{n-1})\\ stride=(d_0,d_1,...,d_{n-1})\\ \]</div> <p>为了完成这个映射，我还需要引入一个概念：整数与多维坐标的同构性 (<a href=https://en.wikipedia.org/wiki/Isomorphism>isomorphism</a>)。在数学上，两个东西同构意味着二者本质上是一个东西，二者可以通过一个映射进行可逆的转换。现在我们来构建整数与多维坐标的转换，就能够证明二者的同构性。我们定义多维坐标是 shape 空间中的一个点<span class=arithmatex>\((x_0,x_1,...,x_{n-1})\)</span>，通过点积我们就能完成多维坐标到整数的转换</p> <div class=arithmatex>\[ x=f(x_0,x_1,...,x_{n-1}) = x_0·1+x_1s_0+...+x_{n-1}\prod_{i=0}^{n-2}s_{i} \]</div> <p>而整数到多维坐标的转换则是通过取余完成</p> <div class=arithmatex>\[ f'(x)=\left( x \bmod s_0,\ \left\lfloor \frac{x}{s_0} \right\rfloor \bmod s_1,\ \ldots,\ \left\lfloor \frac{x}{s_0 \times \cdots \times s_{n-2}} \right\rfloor \bmod s_{n-1} \right) \]</div> <p>实际上这就是列优先的顺序排列方式</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos="1 "></span></a><span class=c1># shape (2, 3) with its int</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos="2 "></span></a><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span><span class=o>&lt;-&gt;</span><span class=mi>0</span>      <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=o>&lt;-&gt;</span><span class=mi>2</span>      <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=o>&lt;-&gt;</span><span class=mi>4</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos="3 "></span></a><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span><span class=o>&lt;-&gt;</span><span class=mi>1</span>      <span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=o>&lt;-&gt;</span><span class=mi>3</span>      <span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=o>&lt;-&gt;</span><span class=mi>5</span>
</span></code></pre></div> <p>有了以上的转换过后就可以定义 layout function 映射了，定义为如下</p> <div class=arithmatex>\[ Layout(x) = g(f'(x)) \]</div> <p>其中<span class=arithmatex>\(f'(·)\)</span>即为将整数转换为坐标的映射，而<span class=arithmatex>\(g(·)\)</span>为将坐标转换为整数的映射，其本质是坐标 coord 与步长 stride 的点积</p> <div class=arithmatex>\[ g(x_0,x_1,...,x_{n-1})=coord ·stride=s_0d_0+s_1d_1+...+s_{n-1}d_{n-1}\\ \]</div> <p>如此一来我们就完成了从整数到整数的映射：我们从整数<span class=arithmatex>\(x\)</span>出发，寻找其对应的坐标点，然后通过步长进行新的映射</p> <p>此时你可能发现了，将<span class=arithmatex>\(f\)</span>与<span class=arithmatex>\(g\)</span>其实非常相似，都是将坐标映射到整数。在之前我也提到了，<span class=arithmatex>\(f\)</span>本身就是 column-major 的排列方式，其可用一个特殊的 layout 来表示，该 layout 我们称之为 layout left (or natural layout)</p> <div class=arithmatex>\[ shape=(s_0,s_1,...,s_{n-1})\\ stride=(d_0,d_1,...,d_{n-1})\\ d_i=\prod_{j=0}^{i-1}s_j=d_{i-1}s_{i-1},d_0=1 \]</div> <p>举一个例子，一个 shape 为 <code>(2, 3, 4)</code> 的 natural layout 为</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos="1 "></span></a><span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>])</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos="2 "></span></a>        <span class=mi>0</span>      <span class=mi>2</span>      <span class=mi>4</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos="3 "></span></a>        <span class=mi>1</span>      <span class=mi>3</span>      <span class=mi>5</span>
</span></code></pre></div> <p>有了 layout left，那就有 layout right，也就是行主序排列</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos="1 "></span></a><span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos="2 "></span></a>        <span class=mi>0</span>      <span class=mi>1</span>      <span class=mi>2</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos="3 "></span></a>        <span class=mi>3</span>      <span class=mi>4</span>      <span class=mi>5</span>
</span></code></pre></div> <p>Layout 其中一个作用就是用来描述坐标与内存位置。这是很自然的事情，因为物理内存永远都是以一维的形式来表达，<strong>所以在 cutlass cute 中就是用一个指针 + 一个 layout 来描述一个 tensor，并且在 cutlass 中以 <code>shape:stride</code> 的形式 print layout</strong></p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos="1 "></span></a><span class=n>Tensor</span><span class=p>(</span><span class=n>Ptr</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=n>Layout</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>layout</span><span class=p>)</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos="2 "></span></a><span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>],</span><span class=w> </span><span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>])</span><span class=w> </span><span class=c1>// (2, 3):(3, 1)</span>
</span></code></pre></div> <p>而实际上 Layout 可以用来描述更多的事情，例如：如何将一个<span class=arithmatex>\((M,N)\)</span>形状 tensor 分配到<span class=arithmatex>\((T,V)\)</span>形状当中。其中<span class=arithmatex>\(T\)</span>就是 threads 数量，<span class=arithmatex>\(V\)</span>是每一个 thread 拥有的 values，这将在基本运算小节中进行介绍</p> <h4 id=_3>基本运算<a class=headerlink href=#_3 title="Permanent link">¶</a></h4> <p>layout algebra 最抽象的部分在于其基本运算，尤其是以下两个基本运算：</p> <ol> <li>complement，补运算</li> <li>compose，复合运算</li> </ol> <p>当然还有其他的运算，例如 concat, coalecse，我用代码来简单解释</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=sd>"""</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a><span class=sd>@dataclass</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a><span class=sd>class Layout:</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a><span class=sd>    shape: List[int]</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a><span class=sd>    stride: List[int]</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a><span class=sd>"""</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>A</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>])</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>B</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=mi>10</span><span class=p>])</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a><span class=n>coalesce</span><span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=c1># Layout(shape=[6], stride=[1])</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11></a><a href=#__codelineno-4-11><span class=linenos data-linenos="11 "></span></a><span class=n>concat</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>)</span><span class=c1># Layout(shape=[2, 3, 4], stride=[1, 2, 10])</span>
</span></code></pre></div> <p>concat 就是将 shape &amp; stride 分别连接，而 coalecse 则是合并 shape &amp; stride，以更少维度呈现</p> <h5 id=complement>Complement<a class=headerlink href=#complement title="Permanent link">¶</a></h5> <p>补运算需要两个元素，整数<span class=arithmatex>\(M\)</span>和 layout 本身。我先用一个一维的例子来说明补运算的作用，这也是 reed zhihu 中所使用到的例子</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos="1 "></span></a><span class=n>A</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos="2 "></span></a><span class=n>B</span> <span class=o>=</span> <span class=n>complement</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>A</span><span class=p>)</span>    <span class=c1># Layout(shape=[2], stride=[1])</span>
</span></code></pre></div> <p>在 reed zhihu 中说到</p> <blockquote> <p>当codomain存在不连续时，则存在空洞的位置，如图4所示，这时候我们可以构造一个Layout2能够填充上codomain的空洞位置，此时我们构造的Layout则为原Layout的补集</p> </blockquote> <p>我认为 complement 的作用是计算出了 layout 所需要重复的“次数”以填满整个<span class=arithmatex>\(M\)</span>空间。用上面的例子来说</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos="1 "></span></a><span class=mi>0</span> <span class=mi>2</span> <span class=mi>4</span> <span class=mi>6</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos="2 "></span></a><span class=mi>0</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=mi>4</span> <span class=mi>5</span> <span class=mi>6</span> <span class=mi>7</span>
</span></code></pre></div> <p>A 还需要重复两次才能够填满 0~8 的整个空间，而后面的 stride 则描述了重复空间之间的间隔，在这里间隔是 1。实际上只需要将 A 和 A 的补 concat 起来就会发现，二者组成了一个连续的空间</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos="1 "></span></a><span class=n>C</span> <span class=o>=</span> <span class=n>concat</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>)</span>    <span class=c1># Layout([4, 2], [2, 1])</span>
</span></code></pre></div> <p>在这个 case 中 concat 过后的结果是一个 layout right 排布</p> <p>再举一个二维的例子</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>A</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>B</span> <span class=o>=</span> <span class=n>complement</span><span class=p>(</span><span class=mi>24</span><span class=p>,</span> <span class=n>A</span><span class=p>)</span>   <span class=c1># Layout(shape=[2, 2], stride=[1, 12])</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a><span class=c1># Layout A</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a><span class=c1>#     0      4      8</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a><span class=c1>#     2      6     10</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a><span class=c1># Layout([4, 6], [1, 4])</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a><span class=c1>#     0      4      8     12     16     20</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a><span class=c1>#     1      5      9     13     17     21</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a><span class=c1>#     2      6     10     14     18     22</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a><span class=c1>#     3      7     11     15     19     23</span>
</span></code></pre></div> <p>可以看到 A 需要在两个维度（在 cutlass 中习惯把一个维度称之为一个 mode）的方向上都分别重复两次。在第一个 mode 上重复空间的间隔是 1，而在第二个 mode 重复空间的间隔是 12。我们仍然可以将 A 和 B 进行对应 mode 的 concat</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a><span class=n>A</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2></a><a href=#__codelineno-9-2><span class=linenos data-linenos="2 "></span></a><span class=n>B</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>12</span><span class=p>])</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3></a><a href=#__codelineno-9-3><span class=linenos data-linenos="3 "></span></a><span class=n>C</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>)],</span> <span class=p>[(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>12</span><span class=p>)])</span>
</span></code></pre></div> <p>concat 之后的 Layout C 实际上可以看做一个合并的 <code>Layout([4, 6], [1, 4])</code></p> <p>现在我们再来看 complement 的公式就会发现其中的奥秘：</p> <div class=arithmatex>\[ \operatorname{complement}(A, M) = \left( d_{0},\ \frac{d_{1}}{s_{0}d_{0}},\ \frac{d_{2}}{s_{1}d_{1}},\ \cdots,\ \frac{M}{s_{a}d_{a}} \right) : \left( 1,\ s_0 d_{0},\ s_1 d_{1},\ \cdots,\ s_a d_{a} \right) \]</div> <p>其本质就是在计算每一个 mode 还需要重复多少次才能够填满整个空间，重复空间的间隔即为子空间大小<span class=arithmatex>\(s_id_i\)</span></p> <h5 id=compose>Compose<a class=headerlink href=#compose title="Permanent link">¶</a></h5> <p>既然是映射（函数），那么将两个函数进行复合是再正常不过的想法了。从直观上来说将两个 layout 进行 compose 非常简单，毕竟都是整数到整数的映射：</p> <div class=arithmatex>\[ g_3=g_1(g_2(x)) \]</div> <p>但是需要考虑的问题是，如何将新的 compose 结果<span class=arithmatex>\(g_3\)</span>描述为一个合法的 layout 结构 <code>(shape, stride)</code>。而这个描述其实还是要化不少笔墨介绍的，这里省略，可参考 Definition 2.13 from <a href=https://research.colfax-intl.com/a-note-on-the-algebra-of-cute-layouts/ >A note on the algebra of CuTe Layouts</a></p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20250525152931437.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20250525152931437.png alt=image-20250525152931437 style=zoom:67%;></a></p> <p>NOTE: 其实 layout algebra 对于输入其实都是有要求的，并不是任意两个 layout 进行 compose 都是可行的，其对于整除性还是有不少要求。好消息是如果数值都是以<span class=arithmatex>\(2^n\)</span>存在，整除性质就会得到很好的保障，而这正是在 GPU 编程中常用的数值。</p> <p>虽然说需要严谨的数学来保证 compose admissibility，但这不妨碍其本质就是上述所说的复合函数，即：从一个 domain 映射到另一个 domain。我将以一个非常具体的例子帮助理解这个 compose 过程</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a><span class=n>TV2MN</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=p>])</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos="2 "></span></a><span class=n>MN2Memory</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></code></pre></div> <p>首先我定义了两个 layout，第一个 <code>TV2MN</code> 描述了 thread values 所对应的 MN 映射。第二个 <code>MN2Memory</code> 描述了 MN 到内存的映射。更具体来说</p> <ol> <li><code>TV2MN</code> 描述了 4 个线程，每一个线程拥有有 (2, 2) 个 values，这些 values 将映射到一个 shape 为 (M, N) 的 tensor 上。该 layout 也将描述 tensor 是如何被分配到线程当中的</li> <li><code>MN2Memory</code> 描述了 tensor 中各个坐标的 value 在内存当中的位置。在例子当中是一个 layout right 的排布，也就 tensor 在内存中是行优先排列</li> </ol> <p>通过 compose 我们可以直接获得 <code>TV2Memory</code> 这样的映射，该映射即代表了内存中的数据如何被分配到线程当中</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos="1 "></span></a><span class=n>TV2Memory</span> <span class=o>=</span> <span class=n>compose</span><span class=p>(</span><span class=n>MN2Memory</span><span class=p>,</span> <span class=n>TV2MN</span><span class=p>)</span> <span class=c1># Layout(shape=[2, 2, 4], stride=[1, 8, 2])</span>
</span></code></pre></div> <p>我们将这个例子打印出来，通过 step by step 的方式看下整个 compose 的过程：</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>TV2MN</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=p>])</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos=" 2 "></span></a>        <span class=mi>0</span><span class=o>|</span>     <span class=mi>1</span><span class=o>|</span>     <span class=mi>8</span><span class=o>|</span>     <span class=mi>9</span><span class=o>|</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=mi>2</span>      <span class=mi>3</span>     <span class=mi>10</span>     <span class=mi>11</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=mi>4</span>      <span class=mi>5</span>     <span class=mi>12</span>     <span class=mi>13</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><a href=#__codelineno-12-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=mi>6</span>      <span class=mi>7</span>     <span class=mi>14</span>     <span class=mi>15</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a><a href=#__codelineno-12-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>MN</span> <span class=n>natural</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a><a href=#__codelineno-12-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=mi>0</span><span class=o>|</span>     <span class=mi>4</span>      <span class=mi>8</span><span class=o>|</span>    <span class=mi>12</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a><a href=#__codelineno-12-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=mi>1</span><span class=o>|</span>     <span class=mi>5</span>      <span class=mi>9</span><span class=o>|</span>    <span class=mi>13</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a><a href=#__codelineno-12-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=mi>2</span>      <span class=mi>6</span>     <span class=mi>10</span>     <span class=mi>14</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a><a href=#__codelineno-12-10><span class=linenos data-linenos="10 "></span></a>        <span class=mi>3</span>      <span class=mi>7</span>     <span class=mi>11</span>     <span class=mi>15</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a><a href=#__codelineno-12-11><span class=linenos data-linenos="11 "></span></a><span class=n>MN2Memory</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><a href=#__codelineno-12-12><span class=linenos data-linenos="12 "></span></a>        <span class=mi>0</span><span class=o>|</span>     <span class=mi>1</span>      <span class=mi>2</span><span class=o>|</span>     <span class=mi>3</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a><a href=#__codelineno-12-13><span class=linenos data-linenos="13 "></span></a>        <span class=mi>4</span><span class=o>|</span>     <span class=mi>5</span>      <span class=mi>6</span><span class=o>|</span>     <span class=mi>7</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><a href=#__codelineno-12-14><span class=linenos data-linenos="14 "></span></a>        <span class=mi>8</span>      <span class=mi>9</span>     <span class=mi>10</span>     <span class=mi>11</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a><a href=#__codelineno-12-15><span class=linenos data-linenos="15 "></span></a>    <span class=mi>12</span>     <span class=mi>13</span>     <span class=mi>14</span>     <span class=mi>15</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a><a href=#__codelineno-12-16><span class=linenos data-linenos="16 "></span></a><span class=n>TV2Memory</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>])</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a><a href=#__codelineno-12-17><span class=linenos data-linenos="17 "></span></a>        <span class=mi>0</span><span class=o>|</span>     <span class=mi>4</span><span class=o>|</span>     <span class=mi>2</span><span class=o>|</span>     <span class=mi>6</span><span class=o>|</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a><a href=#__codelineno-12-18><span class=linenos data-linenos="18 "></span></a>        <span class=mi>8</span>     <span class=mi>12</span>     <span class=mi>10</span>     <span class=mi>14</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a><a href=#__codelineno-12-19><span class=linenos data-linenos="19 "></span></a>        <span class=mi>1</span>      <span class=mi>5</span>      <span class=mi>3</span>      <span class=mi>7</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20></a><a href=#__codelineno-12-20><span class=linenos data-linenos="20 "></span></a>        <span class=mi>9</span>     <span class=mi>13</span>     <span class=mi>11</span>     <span class=mi>15</span>
</span></code></pre></div> <p>以 thread 0 为例：</p> <ol> <li>其对应的 MN index 为 <code>(0, 1, 8, 9)</code></li> <li>通过 MN index 可以找到 <code>(0, 1, 8, 9)</code> 分别对应坐标 <code>(0,0), (1,0), (0,2), (1,2)</code></li> <li>通过对应坐标找到 <code>MN2Memory</code> 所对应的值为 <code>(0, 4, 2, 6)</code></li> <li>所以 thread 0 的 4 个 values 将会寻找内存中第 0, 4, 2, 6 个元素</li> </ol> <p>由此我们就完成了一个映射，其从 TV domain 出发，映射到了 Memory domain。这也引出了 compose 的一个直观性质：不改变 source domain，即输入的 layout “形状”是不会改变的</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos="1 "></span></a><span class=n>TV2MN</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=p>])</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos="2 "></span></a><span class=n>TV2Memory</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>])</span>
</span></code></pre></div> <h5 id=inverse>Inverse<a class=headerlink href=#inverse title="Permanent link">¶</a></h5> <p>同样的，在函数中也存在逆函数。在 layout algebra 中的逆函数定义可参考 <a href=https://zhuanlan.zhihu.com/p/662089556>reed-zhihu</a> 中的 two line notation 表示形式。所谓的 two line 就是：input domain 为一个 line，output domain 为一个 line，下面举一个例子</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># Layout(shape=[2, 3], stride=[3, 1])</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1># [0, 1, 2]</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1># [3, 4, 5]</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a><span class=n>coord</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>value</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a><span class=c1># sort the pair according to value</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>coord</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a><span class=n>value</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a><span class=c1># switch coord and value as new layout</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a><a href=#__codelineno-14-13><span class=linenos data-linenos="13 "></span></a><span class=n>coord</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a><a href=#__codelineno-14-14><span class=linenos data-linenos="14 "></span></a><span class=n>value</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span></code></pre></div> <p>上述 two line notation 用于理解 inverse 是比较直观的，但是对于理解 inverse 过后 layout 形式是怎么样的，没有太大帮助。具体来说，他们的 shape &amp; stride 应该如何得到？在 <a href=https://leimao.github.io/blog/CuTe-Inverse-Layout/ >Lei Mao's blog</a> 当中证明了 compact layout inverse 过后的 shape &amp; stride 应当如何计算，不过 blog 当中的叙述顺序对我来说略显晦涩，我这里用我自己的思考逻辑来整理</p> <p>Conditions:</p> <ul> <li> <p>Layout function:<span class=arithmatex>\(f_L(x)\)</span></p> </li> <li> <p>shape &amp; stride 为<span class=arithmatex>\(S=(s_0,s_1,...,s_n),D=(d_0,d_1,...d_n)\)</span></p> </li> <li> <p>natural layout funciton 将多维坐标<span class=arithmatex>\((x_0, x_1, ...,x_n)\)</span>映射为<span class=arithmatex>\(x\)</span></p> <div class=arithmatex>\[ x=x_0+x_1·s_0+...+x_n·\prod_0^{n-1}s_i \]</div> </li> </ul> <p>Target:</p> <ul> <li> <p>找到 inverse layout:<span class=arithmatex>\(f_{L'}(x)\)</span>使得满足</p> <div class=arithmatex>\[ f_{L'}(f_L(x)) = x \]</div> </li> <li> <p>inverse layout<span class=arithmatex>\(L'\)</span>shape &amp; stride 为<span class=arithmatex>\(S'=(s_0',s_1',...,s_n'),D'=(d_0',d_1',...d_n')\)</span></p> </li> </ul> <p>现在开始正式推导。对于输入<span class=arithmatex>\(x\)</span>对应的<span class=arithmatex>\(L\)</span>坐标为<span class=arithmatex>\((x_0, x_1, ..., x_n)\)</span>，我们设其输出为<span class=arithmatex>\(x'\)</span></p> <div class=arithmatex>\[ f_L(x)=x' \]</div> <p>输出<span class=arithmatex>\(x'\)</span>所对应的<span class=arithmatex>\(L^{-1}\)</span>坐标为<span class=arithmatex>\((x_1',x_2',...,x_n')\)</span>，由<span class=arithmatex>\(L'\)</span>shape 的 natural layout function 完成映射。由等式条件得</p> <div class=arithmatex>\[ \begin{aligned} f_{L'}(f_L(x)) &amp;= f_{L'}(x') \\ &amp;= f_{L'}(x_0',x_1',...,x_n') \\ &amp;= x_0' \cdot d_0' + x_1' \cdot d_1' + \cdots + x_n' \cdot d_n' \\ &amp;= x \\ &amp;= x_0 + x_1 \cdot s_0 + \cdots + x_n \cdot \prod_{i=0}^{n-1} s_i \end{aligned} \]</div> <p>其中最重要的等式为</p> <div class=arithmatex>\[ x_0' \cdot d_0' + x_1' \cdot d_1' + \cdots + x_n' \cdot d_n' =x_0 + x_1 \cdot s_0 + \cdots + x_n \cdot \prod_{i=0}^{n-1} s_i \]</div> <p>下面的证明思路为：如果我们能够找到一个 permutation<span class=arithmatex>\(I=\{i_0,i_1,...,i_n\}\)</span>，使得<span class=arithmatex>\(x_{i_0}'=x_0,x_{i_1}'=x_1,...,x_{i_n}'=x_n\)</span>，那么我们就能对应多项式的每一项，直接算出每一个<span class=arithmatex>\(d'\)</span>的值。现在我们来考察<span class=arithmatex>\((x_0,x_1,...,x_n)\)</span>与<span class=arithmatex>\((x_0',x_1',...,x_n')\)</span>之前的联系是什么，是否存在这样的 permutation</p> <p>他们之间的关系非常清晰</p> <div class=arithmatex>\[ (x_0,x_1,\ldots,x_n) \xleftrightarrow{L} x' \xleftrightarrow{N} (x_0',x_1',\ldots,x_n') \]</div> <p>这里的<span class=arithmatex>\(N\)</span>就是 inverse layout 的 natural function。现在问题转换为：对于一组<span class=arithmatex>\((x_0,x_1,...,x_n)\)</span>与<span class=arithmatex>\((x_0',x_1',...,x_n')\)</span>，他们彼此都是对方的 permutation，我们需要找到合适的 natural layout function 即可。其实对于第一个要求非常好满足（忽略 natural layout 限制），我们可以直接对<span class=arithmatex>\(L\)</span>中的 shape &amp; stride 进行 permute 即可。以简单的 <code>Layout(shape=[2,3], stride=[3,1])</code> 为例子，当 permute shape &amp; stride 时，坐标也随之 permute</p> <div class=arithmatex>\[ (x_0,x_1) \xleftrightarrow{(2,3):(3,1)} x' \xleftrightarrow{(3,2):(1,3)} (x_1,x_0) \]</div> <p>现在只需要考虑 natural layout 的限制即可，而答案也就随之浮出水面：只需要将<span class=arithmatex>\(L\)</span>的 shape &amp; stride permute 成为一个 natural layout (left layout) 即可。更具体来说，根据 stride 的大小，从小到大进行排列，由于 layout 有 compact 保证，没有任何空洞，所以排列出来的 layout 必定也是 natural layout。所以此 permutation 存在且唯一，确定了 inverse layout 的 shape，其对应的 stride 也可由下面的式子进行计算</p> <div class=arithmatex>\[ d_{i_0}'=1,\\ d_{i_1}'=s_0,\\ ...,\\ d_{i_n}'=\prod_{i=0}^{n-1} s_i,\\ \]</div> <p>那么根据上述结论，我们就找到了<span class=arithmatex>\(L'\)</span>的 shape &amp; stride 了！<strong>其中 shape 的结论会很 clean，就是将<span class=arithmatex>\(L\)</span>进行 sort 过后的 shape。从定性来说：原始 stride 小的 shape 在 inverse 过后会靠前；反之则会靠后</strong></p> <p>而在 <a href=https://zhuanlan.zhihu.com/p/1962625273636845008>写给大家看的 CuTe 教程：Layout compose &amp; Inverse</a> 中提到，通常 inverse 过后还会使用 <code>with_shape</code> 来构建我们期望的 layout shape，我们必须要了解 inverse 的输出形状到底是什么，才能正确地使用 <code>with_shape</code>。具体的例子在 retile 部分中，计算 <code>(t, v) -&gt; (m, n)</code> layout 进行展示，其精妙地展示了 inverse 的一个核心作用：domain 的交换。如果我们获得了 <code>(m, n) -&gt; (t, v)</code> 的映射，直接使用 inverse 就可以获得 <code>(t, v) -&gt; (m, n)</code> 映射</p> <h4 id=_4>组合运算<a class=headerlink href=#_4 title="Permanent link">¶</a></h4> <p>有了 layout algebra 所定义的基础运算就可以定义一些更复杂更有用的运算：divide &amp; product</p> <h5 id=divide>divide<a class=headerlink href=#divide title="Permanent link">¶</a></h5> <p>divide 是划分数据中最常用的方法，尤其是 zipped divide。我先介绍 logical divide 的一维运算公式（B 是维度为1的 layout，A 没有限制）</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos="1 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>logical_divide</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>):</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>M</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>size</span><span class=p>()</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a><a href=#__codelineno-15-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>c_B</span> <span class=o>=</span> <span class=n>complement</span><span class=p>(</span><span class=n>M</span><span class=p>,</span> <span class=n>B</span><span class=p>)</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><a href=#__codelineno-15-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>concatenated</span> <span class=o>=</span> <span class=n>concat</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=n>c_B</span><span class=p>)</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><a href=#__codelineno-15-5><span class=linenos data-linenos="5 "></span></a>    <span class=k>return</span> <span class=n>compose</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>concatenated</span><span class=p>)</span>
</span></code></pre></div> <p>可以看到，其先计算了 B 补集，然后与 B 进行了 concat，最后用 concat 过后的 layout 与 A 进行了 compose。通常我们称 layout B 就是一个 <strong>Tiler</strong>，以 Tiler 为粒度对 A 进行了划分。在实际应用过程中都是对一个 layout 进行逐维度 divide (by-mode divide)</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos="1 "></span></a><span class=n>Layout</span><span class=w> </span><span class=n>Shape</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=n>M</span><span class=p>,</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=n>L</span><span class=p>,</span><span class=w> </span><span class=p>...)</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos="2 "></span></a><span class=n>Tiler</span><span class=w> </span><span class=n>Shape</span><span class=w>  </span><span class=o>:</span><span class=w> </span><span class=o>&lt;</span><span class=n>TileM</span><span class=p>,</span><span class=w> </span><span class=n>TileN</span><span class=o>&gt;</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos="3 "></span></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos="4 "></span></a><span class=nl>logical_divide</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>TileM</span><span class=p>,</span><span class=n>RestM</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=n>TileN</span><span class=p>,</span><span class=n>RestN</span><span class=p>),</span><span class=w> </span><span class=n>L</span><span class=p>,</span><span class=w> </span><span class=p>...)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos="5 "></span></a><span class=nl>zipped_divide</span><span class=w>  </span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>TileM</span><span class=p>,</span><span class=n>TileN</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=n>RestM</span><span class=p>,</span><span class=n>RestN</span><span class=p>,</span><span class=n>L</span><span class=p>,...))</span>
</span></code></pre></div> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/divide1.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/divide1.png alt=divide1.png style=zoom:33%;></a></p> <p>在上面的例子中 Tiler 是不连续的，而我们更常会遇到的 Tiler 是最简单的 stride 为 1 的 Tiler。如 <code>B = Layout([4], [1])</code>，这样就会以 4 为单位切分该轴。zipped divide 会将 Tiler 维度直接提到最前面来，以方便我们进行索引操作，通常这个维度可以是 thread，这样通过索引就获得具体某个线程所对应的数据</p> <p>通常我们遇到的情况都是：A &amp; B 都是 1-dim，如果 A 为多维 layout，那么就需要谨慎看待，最后的结果一般不是我们想要的。举个例子</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos="1 "></span></a><span class=n>l1</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>30</span><span class=p>])</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos="2 "></span></a><span class=n>l2</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>([</span><span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos="3 "></span></a><span class=c1># logical_divide(l1, l2) won't work</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos="4 "></span></a><span class=n>A</span> <span class=n>size</span><span class=p>:</span> <span class=mi>20</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos="5 "></span></a><span class=n>complement</span> <span class=n>of</span> <span class=n>B</span><span class=p>:</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>])</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos="6 "></span></a><span class=n>concated</span> <span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=n>c_B</span><span class=p>):</span> <span class=n>Layout</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>],</span> <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></code></pre></div> <p>原因在于 concated layout 无法和 A 进行 compose。不过好消息是在进行数据 divide 时，通常是对 MN shape 进行 divide，这是一个非常规整的 domain，满足我们在 by-mode divide 时各个 mode dim 都是 1 的需求</p> <h5 id=product>product<a class=headerlink href=#product title="Permanent link">¶</a></h5> <p>这里有个割裂感：我们说 product 为 divide 的逆运算，但实际上我发现二者并不能进行可逆操作。例如 <code>C != A.product(B).div(B)</code>。但是这个定义并不符合我们的直觉，严谨的数学定义在 <a href=https://leimao.github.io/article/CuTe-Layout-Algebra/ >Lei Mao's blog</a> 中有所阐述。这里以一个 <a href=https://docs.nvidia.com/cutlass/latest/media/docs/cpp/cute/02_layout_algebra.html#logical-product-2-d-example>2D exmaple</a> 作为说明</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20251027162320196.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20251027162320196.png alt=image-20251027162320196 style="zoom: 67%;"></a></p> <p>这个 product 的结果非常直观：把 <code>(2, 5): (5, 1)</code> 进行重复，重复维度为 <code>(3, 4)</code>。在我的期望中，直接使用 tiler <code>&lt;3:1, 4:1&gt;</code> 就能完成上述功能，但实际上用的 tiler 为 <code>&lt;3:5, 4:6&gt;</code>，这就是因为 product 的定义并不是我们想象中的直观，仍然是根据 complement &amp; compose 来定义的。为了让 product 功能与我们的编程直觉相符，cute 直接构建了几种常见的 api 方便调用，参考 <a href=https://zhuanlan.zhihu.com/p/662089556>reed zhihu</a></p> <table> <thead> <tr> <th>乘法模式</th> <th>乘积的shape</th> </tr> </thead> <tbody> <tr> <td>logical</td> <td>((x, y), (z, w))</td> </tr> <tr> <td>zipped</td> <td>((x, y), (z, w))</td> </tr> <tr> <td>tiled</td> <td>((x, y), z, w)</td> </tr> <tr> <td>blocked</td> <td>((x, z), (y, w))</td> </tr> <tr> <td>raked</td> <td>((z, x), (w, y))</td> </tr> </tbody> </table> <p>上面只列举了 shape，对于 stride 而言，<strong>相同 dimension 的 stride 也是一样的</strong>：即任意乘法模式中所有 x 对应的 stride 都一样。需要注意的是，这些操作是 layout x layout，而不是 layout x tiler。所以他们都是 rank sensitive 的，即两个 layout 的维度必须一致。同时和 divide 一样，通常使用在相对规整的 domain，即 layout 的 size 和 cosize 一致。否则存在空洞的话，product 也可能无法进行，举一个例子</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>l1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_4</span><span class=p>{},</span><span class=w> </span><span class=n>_5</span><span class=p>{}),</span><span class=w> </span><span class=n>make_stride</span><span class=p>(</span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>30</span><span class=o>&gt;</span><span class=p>{},</span><span class=w> </span><span class=n>_1</span><span class=p>{}));</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>l2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_2</span><span class=p>{},</span><span class=w> </span><span class=n>_4</span><span class=p>{}));</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos="3 "></span></a><span class=c1>// can't do logical_product(l1, l2)</span>
</span></code></pre></div> <p>这里点出一个 product 和 divide 的重要差异：divide 习惯使用 layout divide tiler，而 product 习惯使用 layout product layout。另外一个实验是，product 的顺序是会改变结果的</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>base_layout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_4</span><span class=p>{},</span><span class=w> </span><span class=n>_3</span><span class=p>{}),</span><span class=w> </span><span class=n>make_stride</span><span class=p>(</span><span class=n>_4</span><span class=p>{},</span><span class=w> </span><span class=n>_1</span><span class=p>{}));</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>layout_x2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blocked_product</span><span class=p>(</span><span class=n>base_layout</span><span class=p>,</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_1</span><span class=p>{},</span><span class=w> </span><span class=n>_2</span><span class=p>{})));</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos="3 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>layout_x2_x2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blocked_product</span><span class=p>(</span><span class=n>layout_x2</span><span class=p>,</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_2</span><span class=p>{},</span><span class=w> </span><span class=n>_1</span><span class=p>{})));</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos="4 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>layout_x4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blocked_product</span><span class=p>(</span><span class=n>base_layout</span><span class=p>,</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_2</span><span class=p>{},</span><span class=w> </span><span class=n>_2</span><span class=p>{})));</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a><a href=#__codelineno-19-5><span class=linenos data-linenos="5 "></span></a>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a><a href=#__codelineno-19-6><span class=linenos data-linenos="6 "></span></a><span class=c1>// Product order test</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7></a><a href=#__codelineno-19-7><span class=linenos data-linenos="7 "></span></a><span class=c1>// ((_4,_1),(_3,_2)):((_4,_0),(_1,_16))</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8></a><a href=#__codelineno-19-8><span class=linenos data-linenos="8 "></span></a><span class=c1>// (((_4,_1),_2),((_3,_2),_1)):(((_4,_0),_32),((_1,_16),_0))</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9></a><a href=#__codelineno-19-9><span class=linenos data-linenos="9 "></span></a><span class=c1>// ((_4,_2),(_3,_2)):((_4,_16),(_1,_32))</span>
</span></code></pre></div> <p>我先对 base layout 在第二个 dim 进行扩张，然后再对第一个维度进行扩张，其结果和同时扩张两个维度是不一致的。在之后的内容当中，我们可以使用组合运算和基础运算来获得所需的 layout 排布，在实践中学习</p> <h3 id=mma>MMA<a class=headerlink href=#mma title="Permanent link">¶</a></h3> <h4 id=mma-atom>MMA Atom<a class=headerlink href=#mma-atom title="Permanent link">¶</a></h4> <p>mma atom 可以大致认为由两个部分组成：mma op &amp; mma traits</p> <ol> <li> <p>MMA op 用于描述所使用的 PTX 命令，以及该命令所需要的寄存器</p> </li> <li> <p>MMA traits 用于描述需要完成一个 MMA 所缺失的部分：包含数据类型、数据形状，线程数据排布 tv layouts</p> </li> </ol> <p>以 mma op <code>SM80_16x8x16_F16F16F16F16_TN</code> 为例来说明</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// MMA 16x8x16 TN</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>SM80_16x8x16_F16F16F16F16_TN</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos=" 3 "></span></a><span class=p>{</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>DRegisters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>uint32_t</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ARegisters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>uint32_t</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6></a><a href=#__codelineno-20-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>BRegisters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>uint32_t</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7></a><a href=#__codelineno-20-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>CRegisters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>uint32_t</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8></a><a href=#__codelineno-20-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9></a><a href=#__codelineno-20-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=n>CUTE_HOST_DEVICE</span><span class=w> </span><span class=k>static</span><span class=w> </span><span class=kt>void</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10></a><a href=#__codelineno-20-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=n>fma</span><span class=p>(</span><span class=kt>uint32_t</span><span class=w>      </span><span class=o>&amp;</span><span class=w> </span><span class=n>d0</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w>      </span><span class=o>&amp;</span><span class=w> </span><span class=n>d1</span><span class=p>,</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11></a><a href=#__codelineno-20-11><span class=linenos data-linenos="11 "></span></a><span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>a0</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>a1</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>a2</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>a3</span><span class=p>,</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12></a><a href=#__codelineno-20-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>b0</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>b1</span><span class=p>,</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13></a><a href=#__codelineno-20-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>c0</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>c1</span><span class=p>)</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14></a><a href=#__codelineno-20-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15></a><a href=#__codelineno-20-15><span class=linenos data-linenos="15 "></span></a><span class=cp>#if defined(CUTE_ARCH_MMA_SM80_ENABLED)</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16></a><a href=#__codelineno-20-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=k>asm</span><span class=w> </span><span class=k>volatile</span><span class=p>(</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17></a><a href=#__codelineno-20-17><span class=linenos data-linenos="17 "></span></a><span class=w>        </span><span class=s>"mma.sync.aligned.m16n8k16.row.col.f16.f16.f16.f16 "</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18></a><a href=#__codelineno-20-18><span class=linenos data-linenos="18 "></span></a><span class=w>        </span><span class=s>"{%0,  %1},"</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19></a><a href=#__codelineno-20-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=s>"{%2,  %3,  %4,  %5},"</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20></a><a href=#__codelineno-20-20><span class=linenos data-linenos="20 "></span></a><span class=w>        </span><span class=s>"{%6,  %7},"</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21></a><a href=#__codelineno-20-21><span class=linenos data-linenos="21 "></span></a><span class=w>        </span><span class=s>"{%8,  %9};</span><span class=se>\n</span><span class=s>"</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22></a><a href=#__codelineno-20-22><span class=linenos data-linenos="22 "></span></a><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=s>"=r"</span><span class=p>(</span><span class=n>d0</span><span class=p>),</span><span class=w> </span><span class=s>"=r"</span><span class=p>(</span><span class=n>d1</span><span class=p>)</span>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23></a><a href=#__codelineno-20-23><span class=linenos data-linenos="23 "></span></a><span class=w>        </span><span class=o>:</span><span class=w>  </span><span class=s>"r"</span><span class=p>(</span><span class=n>a0</span><span class=p>),</span><span class=w>  </span><span class=s>"r"</span><span class=p>(</span><span class=n>a1</span><span class=p>),</span><span class=w>  </span><span class=s>"r"</span><span class=p>(</span><span class=n>a2</span><span class=p>),</span><span class=w>  </span><span class=s>"r"</span><span class=p>(</span><span class=n>a3</span><span class=p>),</span>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24></a><a href=#__codelineno-20-24><span class=linenos data-linenos="24 "></span></a><span class=w>            </span><span class=s>"r"</span><span class=p>(</span><span class=n>b0</span><span class=p>),</span><span class=w>  </span><span class=s>"r"</span><span class=p>(</span><span class=n>b1</span><span class=p>),</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25></a><a href=#__codelineno-20-25><span class=linenos data-linenos="25 "></span></a><span class=w>            </span><span class=s>"r"</span><span class=p>(</span><span class=n>c0</span><span class=p>),</span><span class=w>  </span><span class=s>"r"</span><span class=p>(</span><span class=n>c1</span><span class=p>));</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26></a><a href=#__codelineno-20-26><span class=linenos data-linenos="26 "></span></a><span class=cp>#else</span>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27></a><a href=#__codelineno-20-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=n>CUTE_RUNTIME_ASSERT</span><span class=p>(</span><span class=s>"Attempting to use SM80_16x8x16_F16F16F16F16_TN without CUTE_ARCH_MMA_SM80_ENABLED"</span><span class=p>);</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28></a><a href=#__codelineno-20-28><span class=linenos data-linenos="28 "></span></a><span class=cp>#endif</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29></a><a href=#__codelineno-20-29><span class=linenos data-linenos="29 "></span></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30></a><a href=#__codelineno-20-30><span class=linenos data-linenos="30 "></span></a><span class=p>};</span>
</span></code></pre></div> <p>该 mma op 就是用来封装 PTX 接口的，给出所使用的命令以及该命令需要的寄存器。该 PTX 命令是一个 16x8x16 的矩阵乘，对应的数据类型都是浮点，而 <code>TN</code> 代表的是 transposed &amp; normal，分别代表 row-major &amp; col-major。需要强调两点：</p> <ol> <li>是 <code>TN</code> 并不是代表矩阵 A &amp; B 他们的数据排布就是 row-major &amp; col-major，这其实只是 PTX 遵循 BLAS 当中的语言约定。而真实的 A &amp; B 数据排布，参考 <a href=https://github.com/NVIDIA/cutlass/blob/main/media/docs/cpp/cute/0x_gemm_tutorial.md#aside-m-major-n-major-k-major>TN &amp; NT &amp; TT &amp; NN</a>，<code>TN</code> 其实都是 row-major。并且输出的 C 也是 row-major</li> <li>PTX 命令名字虽然包含了矩阵形状以及数据类型，但是只是名字，实际上在 mma op 中并不具体包含这些信息，所以仍需要 mma traits 提供</li> </ol> <p>接下来看该 mma op 对应的 mma traits</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;&gt;</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2></a><a href=#__codelineno-21-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>MMA_Traits</span><span class=o>&lt;</span><span class=n>SM80_16x8x16_F16F16F16F16_TN</span><span class=o>&gt;</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3></a><a href=#__codelineno-21-3><span class=linenos data-linenos=" 3 "></span></a><span class=p>{</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4></a><a href=#__codelineno-21-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ValTypeD</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>half_t</span><span class=p>;</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5></a><a href=#__codelineno-21-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ValTypeA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>half_t</span><span class=p>;</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6></a><a href=#__codelineno-21-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ValTypeB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>half_t</span><span class=p>;</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7></a><a href=#__codelineno-21-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ValTypeC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>half_t</span><span class=p>;</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8></a><a href=#__codelineno-21-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9></a><a href=#__codelineno-21-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>Shape_MNK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Shape</span><span class=o>&lt;</span><span class=n>_16</span><span class=p>,</span><span class=n>_8</span><span class=p>,</span><span class=n>_16</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10></a><a href=#__codelineno-21-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ThrID</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>_32</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11></a><a href=#__codelineno-21-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ALayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_4</span><span class=p>,</span><span class=n>_8</span><span class=o>&gt;</span><span class=p>,</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_2</span><span class=p>,</span><span class=n>_2</span><span class=p>,</span><span class=w>  </span><span class=n>_2</span><span class=o>&gt;&gt;</span><span class=p>,</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12></a><a href=#__codelineno-21-12><span class=linenos data-linenos="12 "></span></a><span class=w>                            </span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_32</span><span class=p>,</span><span class=n>_1</span><span class=o>&gt;</span><span class=p>,</span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_16</span><span class=p>,</span><span class=n>_8</span><span class=p>,</span><span class=n>_128</span><span class=o>&gt;&gt;&gt;</span><span class=p>;</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13></a><a href=#__codelineno-21-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>BLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_4</span><span class=p>,</span><span class=n>_8</span><span class=o>&gt;</span><span class=p>,</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=n>_2</span><span class=p>,</span><span class=w> </span><span class=n>_2</span><span class=o>&gt;&gt;</span><span class=p>,</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14></a><a href=#__codelineno-21-14><span class=linenos data-linenos="14 "></span></a><span class=w>                            </span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_16</span><span class=p>,</span><span class=n>_1</span><span class=o>&gt;</span><span class=p>,</span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_8</span><span class=p>,</span><span class=n>_64</span><span class=o>&gt;&gt;&gt;</span><span class=p>;</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15></a><a href=#__codelineno-21-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>CLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SM80_16x8_Row</span><span class=p>;</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16></a><a href=#__codelineno-21-16><span class=linenos data-linenos="16 "></span></a><span class=p>};</span>
</span></code></pre></div> <p>正如我之前所说，mma traits 提供了：数据类型 (val type)、数据形状 (shape mnk)、线程数据排布 (thread id, ABC layout)</p> <p>线程排布其实就是 tv layouts，描述的 (threads, values) -&gt; MK 的映射关系，在 reed zhihu 中用更详细的注释说明：</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos="1 "></span></a><span class=k>using</span><span class=w> </span><span class=n>ALayout</span><span class=w> </span><span class=o>=</span><span class=w>      </span><span class=c1>// (Logical thread id (tid), Logical value id (vid)) -&gt; Flat MK-coord</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos="2 "></span></a><span class=k>using</span><span class=w> </span><span class=n>BLayout</span><span class=w> </span><span class=o>=</span><span class=w>      </span><span class=c1>// (Logical thread id (tid), Logical value id (vid)) -&gt; Flat NK-coord</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos="3 "></span></a><span class=k>using</span><span class=w> </span><span class=n>CLayout</span><span class=w> </span><span class=o>=</span><span class=w>      </span><span class=c1>// (Logical thread id (tid), Logical value id (vid)) -&gt; Flat MN-coord</span>
</span></code></pre></div> <h4 id=tiledmma>TiledMMA<a class=headerlink href=#tiledmma title="Permanent link">¶</a></h4> <p>mma atom 提供了一个 warp 所能完成的矩阵乘大小，通常我们会在一个 block 中使用更多的 threads，将多个 mma atom 组成一个 tiled mma。该组合通过参数 <code>AtomLayoutMNK</code> 来定义 atom 在 MNK 方向上重复的次数。</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos="1 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>kMmaEURepeatM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>kMmaEURepeatN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3></a><a href=#__codelineno-23-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>kMmaEURepeatK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4></a><a href=#__codelineno-23-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>MMA_EU_RepeatT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>Int</span><span class=o>&lt;</span><span class=n>kMmaEURepeatM</span><span class=o>&gt;</span><span class=p>{},</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=n>kMmaEURepeatN</span><span class=o>&gt;</span><span class=p>{},</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=n>kMmaEURepeatK</span><span class=o>&gt;</span><span class=p>{})));</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5></a><a href=#__codelineno-23-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>MMA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>make_tiled_mma</span><span class=p>(</span><span class=n>mma_atom</span><span class=p>{},</span><span class=w> </span><span class=n>MMA_EU_RepeatT</span><span class=p>{});</span>
</span></code></pre></div> <p>上述代码在 MN 方向上重复了两次，于是从原来的 <code>16x8x16</code> 变为了 <code>32x16x16</code> 的矩阵乘</p> <p>NOTE：绝大多数的情况下，都是在 MN 方向上重复 mma atom，几乎从来不会在 K 方向上重复 mma atom <a href=https://github.com/NVIDIA/cutlass/issues/1391#issuecomment-1987272892>[QST] TiledMMA with <code>&gt;1</code> Atoms in K dimension --- how to reduce?</a>。这其实是合理的，在 MN 方向上的重复可以通过简单的 atom 重复完成，而 K 方向上的重复需要进行额外的累加：即需要将多个重复的 mma atom 结果进行累加。通常在 K 方向的累加是通过 main loop 完成</p> <p>另外还有一个参数 <code>PermutationMNK</code>，该参数是比较迷惑的，对于该参数的解释最终都会回到 <a href=https://github.com/NVIDIA/cutlass/discussions/1345>[QST] What is PermutationMNK in TiledMMA in CUTLASS 3.4 changes?</a>。其中对 <code>PermuationMNK</code> 最本质的介绍是：</p> <blockquote> <p>The easiest way to think about it is that the <code>Permutation</code> parameter is a <strong>Tiler</strong> for the MNK modes of the MMA.</p> </blockquote> <p>我先举一个实际例子说明其功能，再总结一下其影响</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos="1 "></span></a><span class=w>    </span><span class=c1>// mma atom shape is 16x8x16</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>mma_atom_shape</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mma_traits</span><span class=o>::</span><span class=n>Shape_MNK</span><span class=p>;</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>kMmaPM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>kMmaEURepeatM</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>get</span><span class=o>&lt;</span><span class=mi>0</span><span class=o>&gt;</span><span class=p>(</span><span class=n>mma_atom_shape</span><span class=p>{});</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>kMmaPN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>kMmaEURepeatN</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>get</span><span class=o>&lt;</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>mma_atom_shape</span><span class=p>{});</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5></a><a href=#__codelineno-24-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>kMmaPK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>kMmaEURepeatK</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>get</span><span class=o>&lt;</span><span class=mi>2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>mma_atom_shape</span><span class=p>{});</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6></a><a href=#__codelineno-24-6><span class=linenos data-linenos="6 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>MMA_P_T</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Tile</span><span class=o>&lt;</span><span class=n>Int</span><span class=o>&lt;</span><span class=n>kMmaPM</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=n>kMmaPN</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=n>kMmaPK</span><span class=o>&gt;&gt;</span><span class=p>;</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7></a><a href=#__codelineno-24-7><span class=linenos data-linenos="7 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>MMA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>make_tiled_mma</span><span class=p>(</span><span class=n>mma_atom</span><span class=p>{},</span><span class=w> </span><span class=n>MMA_EU_RepeatT</span><span class=p>{},</span><span class=w> </span><span class=n>MMA_P_T</span><span class=p>{}));</span>
</span></code></pre></div> <p>这里 <code>MMA_P_T</code> 就是 <code>PermutationMNK</code>，在例子中的具体值为 <code>M=(16x2), N=(8x2x2), K=(16)</code>，即 <code>32x32x16</code>。由此就形成了一个 <code>32x32x16</code> 的 Tiler，会将输入数据按照这个 Tiler 形状进行分割。可以看到我们在 <code>AtomLayoutMNK</code> 重复的基础上，再对 N 方向又扩大了一倍</p> <p>该参数有两个功能：</p> <ol> <li> <p>对数据进行 permute，影响 data partition 结果（现在基本不使用该功能）</p> <p>如果 tiler 中某一个维度使用了特殊的 layout 例如 <code>Layout&lt;Shape &lt;_2,_4,_4&gt;, Stride&lt;_1,_8,_2&gt;&gt;</code>，这将会对数据进行重新的排布。但并不会影响最终的矩阵乘结果，因为 permutation 不改变 reduction 结果，并且最后数据在 copy 的过程中也会回到 permutation 之前的位置</p> </li> <li> <p><strong>影响 <code>get_layoutA/B/C_TV</code> &amp; <code>tile_size</code>。不影响 data partition 结果</strong></p> <p>该功能用于扩大 tiler size 以增加 A/B/C tv layouts 中的 v size，从而满足 tiled copy 对 v size 的要求（这一句话高度抽象，一定要配合之后对 tiled copy 的学习）。简单来说，有的 mma atom tv layouts 中，size of v 为 4，即每一个线程分配 4 个 values；而 ldmatrix copy atom 会要求 size of v 至少为 8。在此情形下，直接使用 mma tv layouts 将不会满足要求，而需要增加 v size，该需求就是利用 <code>PermutationMNK</code> 扩大 MN shape 而满足的</p> </li> </ol> <h4 id=thrmma>ThrMMA<a class=headerlink href=#thrmma title="Permanent link">¶</a></h4> <p>thread mma 的作用是根据 tiled mma 中所定义的 block tv layouts &amp; mnk shape 对 tensor 进行划分（这里我忽略 <code>permuationMNK</code> 所带来的数据排布影响），获得每一个线程所需要的数据。对于一个 tensor shape <code>(M, N)</code>，使用 thread mma 按照 matrix A 的 tv layouts &amp; mn shape 对 tensor 划分过后得到每个线程的 tensor shape 为：</p> <div class=arithmatex>\[ (\text{num}_V, \text{num}_M, \text{num}_N)=(V, \frac{M}{m},\frac{N}{n}) \]</div> <p>第一个维度 <code>num_v</code> 代表了 block tv layouts 当中每一个 thread 控制的 values 数量，而 <code>num_M</code> 和 <code>num_N</code> 则代表 tensor 中的的 M &amp; N 在各自维度上包含了多少个 atom。以上述 tiled mma 为例子，matrix B block tv layouts 中每一个 thread 有 4 个 values，nk shape 为 <code>(16, 16) = (8x2, 16)</code>，所以如果我们给定一个 tensor shape 为 <code>(128, 32)</code> 的话，得到的 thread tensor shape 为 <code>(4, 8, 2) = (4, 128/16, 32/16)</code></p> <p><strong>ThrMMA 的作用仅限于划分，最终传入 <code>cute::gemm</code> 方法的仍然是 TiledMMA</strong></p> <h3 id=copy>Copy<a class=headerlink href=#copy title="Permanent link">¶</a></h3> <p>copy 其实是比 mma 更加灵活更加复杂的操作。因为其要考虑到不同的硬件结构 (global memory, shared memory, register)，以及 source &amp; destination 对于数据排布不同的要求。GPU 编程的魅力之一就在于如何搬运大量数据以增加数据吞吐量</p> <h4 id=copy-atom>Copy Atom<a class=headerlink href=#copy-atom title="Permanent link">¶</a></h4> <p>copy atom 我认为由三个部分组成：copy op, copy traits, copy type。</p> <ol> <li>copy op 用于描述 PTX 指令以及所需的寄存器</li> <li>copy traits 用于描述 src &amp; dst tv layouts，以及线程数量。这里的 tv layouts 区别于 mma atom，其映射的 domain 不是矩阵的 shape，而是 bits，在实际使用过程中实际上是提供的数据的<strong>逻辑位置</strong>。这在之后的 ldmatrix/tiled copy 小节中将具体表现</li> <li>copy type 表示数据类型</li> </ol> <p>相比于 mma traits，copy traits 不一定是以 warp 单位来定义，即 tv layouts 中的 t 大小不一定是 32。我对此有一些疑问：难道 GPU 不都应该以 warp 为单位来执行吗？看来我将执行单元和内存操作的最小单位混淆了，二者应当区分看待</p> <blockquote> <p>From DeepSeek</p> <p>Warp 是执行单元，但不是内存操作的最小单位。确实，warp（32线程）是 GPU 的基本执行单元，但内存操作的最小单位不一定与 warp 对齐。这些指令可以由单个线程发起（虽然通常整个 warp 会协同工作）支持各种大小和模式</p> </blockquote> <p>下面就是一个具体的 copy atom 及其对应 copy traits 在实际代码中的使用</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos="1 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cute</span><span class=o>::</span><span class=n>half_t</span><span class=p>;</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a><a href=#__codelineno-25-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>g2s_copy_op</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SM80_CP_ASYNC_CACHEGLOBAL</span><span class=o>&lt;</span><span class=n>cute</span><span class=o>::</span><span class=n>uint128_t</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a><a href=#__codelineno-25-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>g2s_copy_traits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Copy_Traits</span><span class=o>&lt;</span><span class=n>g2s_copy_op</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a><a href=#__codelineno-25-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>g2s_copy_atom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Copy_Atom</span><span class=o>&lt;</span><span class=n>g2s_copy_traits</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span>
</span></code></pre></div> <p>这里创建了一个 global to shared memory 的 copy atom，每一个 copy atom 可以完成一个 128bit 的数据搬运，由于我们使用的数据类型为半精度 16bit，所以一次将搬运 8 个数据元素</p> <h4 id=tiledcopy>TiledCopy<a class=headerlink href=#tiledcopy title="Permanent link">¶</a></h4> <p>同样的，和 tiled mma 一样，我们在一个 block 当中通常会有多个 threads，我们仍然需要对 copy atom 进行排布，组成一个更大的 tiled copy。下面就是一个创建 tiled copy 的例子</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos="1 "></span></a><span class=w>    </span><span class=c1>// Each Tile will copy 32x32 half_t elements</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2></a><a href=#__codelineno-26-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>G2SCopyA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>make_tiled_copy</span><span class=p>(</span><span class=n>g2s_copy_atom</span><span class=p>{},</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3></a><a href=#__codelineno-26-3><span class=linenos data-linenos="3 "></span></a><span class=w>                                            </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>32</span><span class=o>&gt;</span><span class=p>{},</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>4</span><span class=o>&gt;</span><span class=p>{}),</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4></a><a href=#__codelineno-26-4><span class=linenos data-linenos="4 "></span></a><span class=w>                                                        </span><span class=n>make_stride</span><span class=p>(</span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>4</span><span class=o>&gt;</span><span class=p>{},</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>{})),</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5></a><a href=#__codelineno-26-5><span class=linenos data-linenos="5 "></span></a><span class=w>                                            </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>{},</span><span class=w> </span><span class=n>Int</span><span class=o>&lt;</span><span class=mi>8</span><span class=o>&gt;</span><span class=p>{}))));</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6></a><a href=#__codelineno-26-6><span class=linenos data-linenos="6 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>G2SCopyB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>G2SCopyA</span><span class=p>;</span>
</span></code></pre></div> <p>该 tiled copy 负责将 A &amp; B 矩阵从 global memory 复制到 shared memory，每一次 copy 的 mn shape 为 <code>(32, 32)</code>。我想从 <code>make_tiled_copy</code> 的具体实现来看下传入参数的含义，我认为非常巧妙</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>make_tiled_copy</span><span class=p>(</span><span class=n>Copy_Atom</span><span class=o>&lt;</span><span class=n>Args</span><span class=p>...</span><span class=o>&gt;</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>copy_atom</span><span class=p>,</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos=" 2 "></span></a><span class=w>                </span><span class=n>ThrLayout</span><span class=w>          </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>thr_layout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{},</span><span class=w>     </span><span class=c1>// (m,n) -&gt; thr_idx</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos=" 3 "></span></a><span class=w>                </span><span class=n>ValLayout</span><span class=w>          </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>val_layout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{})</span><span class=w>     </span><span class=c1>// (m,n) -&gt; val_idx</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5></a><a href=#__codelineno-27-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=c1>// Take the raked_products to compute the Layout_MN</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6></a><a href=#__codelineno-27-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=c1>// (M,N) -&gt; (thr_idx, val_idx)</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7></a><a href=#__codelineno-27-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>layout_mn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>raked_product</span><span class=p>(</span><span class=n>thr_layout</span><span class=p>,</span><span class=w> </span><span class=n>val_layout</span><span class=p>);</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8></a><a href=#__codelineno-27-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=c1>// (thr_idx, val_idx) -&gt; (M,N)</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9></a><a href=#__codelineno-27-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>layout_tv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>right_inverse</span><span class=p>(</span><span class=n>layout_mn</span><span class=p>).</span><span class=n>with_shape</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>size</span><span class=p>(</span><span class=n>thr_layout</span><span class=p>),</span><span class=w> </span><span class=n>size</span><span class=p>(</span><span class=n>val_layout</span><span class=p>)));</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10></a><a href=#__codelineno-27-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=c1>// Tiler for extracting relevant elements</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11></a><a href=#__codelineno-27-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=c1>// (M,N) -&gt; tensor coord</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12></a><a href=#__codelineno-27-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>tiler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product_each</span><span class=p>(</span><span class=n>shape</span><span class=p>(</span><span class=n>layout_mn</span><span class=p>));</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13></a><a href=#__codelineno-27-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>make_tiled_copy_impl</span><span class=p>(</span><span class=n>copy_atom</span><span class=p>,</span><span class=w> </span><span class=n>layout_tv</span><span class=p>,</span><span class=w> </span><span class=n>tiler</span><span class=p>);</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14></a><a href=#__codelineno-27-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</span></code></pre></div> <p>可以看到在构造 tiled copy 中我们传入了两个 layout，一个是 <code>thr_layout</code>，另一个是 <code>val_layout</code>，我在一开始看到这两个 layout 的时候，只是单纯地觉得这就是在描述 thread 和 values 的排布，然后把这两个 layout 乘起来就获得了一个 <code>(32, 32)</code> 的 layout，正好就是 tiled copy 所覆盖的 tensor 区域，并且我错误地认为了这是一个 tv -&gt; mn 的映射。而实际上这两个 layout 在描述 <code>(m=32, n=4) -&gt; tid</code> 和 <code>(m=1, n=8) -&gt; vid</code> 的映射，通过 raked product 进行了 interleaved 重复获得了 <code>(m, n) -&gt; (tid, vid)</code> 的映射。所谓 interleaved 重复即为：在第二个维度是将 8 重复 4 次，而不是将 4 重复 8 次。这在实际的映射中表现为，在 n 方向会先看到同一个 thread 所拥有的连续 values，而不是同一个 value 的连续 thread。最后通过 right inverse 将映射返回成为 <code>(tid, vid) -&gt; (m, n)</code></p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>Shape</span><span class=o>&lt;</span><span class=n>_32</span><span class=p>,</span><span class=w> </span><span class=n>_4</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_4</span><span class=p>,</span><span class=w> </span><span class=n>_1</span><span class=o>&gt;&gt;</span><span class=p>{};</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2></a><a href=#__codelineno-28-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>tiler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>Shape</span><span class=o>&lt;</span><span class=n>_2</span><span class=p>,</span><span class=w> </span><span class=n>_8</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_8</span><span class=p>,</span><span class=w> </span><span class=n>_1</span><span class=o>&gt;&gt;</span><span class=p>{};</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3></a><a href=#__codelineno-28-3><span class=linenos data-linenos="3 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>lxtiler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>logical_product</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>tiler</span><span class=p>);</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4></a><a href=#__codelineno-28-4><span class=linenos data-linenos="4 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>lxtiler_rake</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>raked_product</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>tiler</span><span class=p>);</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5></a><a href=#__codelineno-28-5><span class=linenos data-linenos="5 "></span></a>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6></a><a href=#__codelineno-28-6><span class=linenos data-linenos="6 "></span></a><span class=p>((</span><span class=n>_32</span><span class=p>,</span><span class=n>_4</span><span class=p>),(</span><span class=n>_2</span><span class=p>,</span><span class=n>_8</span><span class=p>))</span><span class=o>:</span><span class=p>((</span><span class=n>_4</span><span class=p>,</span><span class=n>_1</span><span class=p>),(</span><span class=n>_1024</span><span class=p>,</span><span class=n>_128</span><span class=p>))</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7></a><a href=#__codelineno-28-7><span class=linenos data-linenos="7 "></span></a><span class=p>((</span><span class=n>_2</span><span class=p>,</span><span class=n>_32</span><span class=p>),(</span><span class=n>_8</span><span class=p>,</span><span class=n>_4</span><span class=p>))</span><span class=o>:</span><span class=p>((</span><span class=n>_1024</span><span class=p>,</span><span class=n>_4</span><span class=p>),(</span><span class=n>_128</span><span class=p>,</span><span class=n>_1</span><span class=p>))</span>
</span></code></pre></div> <p>可以看到 <code>make_tiled_copy</code> 中还有一个 <code>make_tiled_copy_impl</code>，这个函数接受了两个参数 <code>layout_tv</code> 以及其对应的 <code>tiler</code>，他们二者就共同描述了 tiled copy 如何去划分一个 tiler 大小的数据，然后进行 copy。在实践过程中这个 <code>layout_tv</code> 通常可以是 tiled mma 中的 <code>get_layoutA/B/C_TV</code>，而 tiler 大小就是 <code>PermutationMNK</code> 所设置的 tiler size 大小</p> <p>在上述例子当中只需要一个 block 进行一次 copy 就能够完成 <code>(32, 32)</code> 大小的 copy 任务。还有一种情况，<strong>一个 tiled copy 需要一个 block 进行多次来完成 <code>(32, 32)</code> 大小的 copy 任务</strong>，例如将上述例子中的 copy atom 换为 <code>Copy_Atom&lt;UniversalCopy&lt;cute::uint32_t&gt;, T&gt;</code>，一个线程只会复制两个 fp16 元素，此时 128 个线程只能够复制 256 个 fp16 元素，很明显并不能够一次完成 <code>(32, 32)</code> 大小的 copy 任务。所以一个 tiled copy 会执行多次来完成该 copy 任务</p> <h4 id=thrcopy>ThrCopy<a class=headerlink href=#thrcopy title="Permanent link">¶</a></h4> <p>利用 tiled copy 当中的 tiled tv layout &amp; mn shape 对 tensor <code>(M, N)</code> 进行划分，得到每一个线程所拥有的 tensor，表达公式其实和 ThrMMA 是一样的</p> <div class=arithmatex>\[ (\text{num}_V, \text{num}_M, \text{num}_N)=(V, \frac{M}{m},\frac{N}{n}) \]</div> <p>但不一样的是 <code>num_V</code> 不一定就是 copy atom 中的 values 数量，还可能是由于 tiled copy 会重复多次执行 copy atom 所导致的 <code>num_V</code> 的增加</p> <p><strong>ThrCopy 的作用仅限于划分， 最终传入 <code>cute::copy</code> 方法的仍然是 TiledCopy</strong></p> <h4 id=ldmatrix>ldmatrix<a class=headerlink href=#ldmatrix title="Permanent link">¶</a></h4> <p>ldmatrix 是为了满足 mma atom 的特殊排布应运而生，ldmatrix 能够将自己线程的数据发送到其他线程当中，这在常规的 CUDA 编程中是做不到的，因为在 SIMT 编程下我们认为寄存器是线程私有的。</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/v2-c1031c4aa65e40d119c601740b9afd1c_1440w.jpg data-desc-position=bottom><img src=CUDA%20Programming%208.1/v2-c1031c4aa65e40d119c601740b9afd1c_1440w.jpg alt=img style=zoom:50%;></a></p> <p>第一张图描述了 ldmatrix 的高效性：一个 thread 将搬运 8 个元素，并分配到不同的线程当中。在一般的 LDS 命令下，一个 thread 只能搬运 2 个元素，所以要进行 4 次搬运，效率大大降低。</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/v2-5a2257c2bea9b2f6652cfe579444f3bb_720w.webp data-desc-position=bottom><img src=CUDA%20Programming%208.1/v2-5a2257c2bea9b2f6652cfe579444f3bb_720w.webp alt=img style=zoom:67%;></a></p> <p>第二张图则需要对应我们的 copy traits 一起食用。该图其实就是 ldmatrix 的 warp 版本。其搬运了一个 <code>(16, 16)</code> 大小的 half 矩阵。需要注意的是数据排布顺序要按照图示中的箭头来看</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;&gt;</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>Copy_Traits</span><span class=o>&lt;</span><span class=n>SM75_U32x4_LDSM_N</span><span class=o>&gt;</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos=" 3 "></span></a><span class=p>{</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4></a><a href=#__codelineno-29-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=c1>// Logical thread id to thread idx (warp)</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5></a><a href=#__codelineno-29-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ThrID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>_32</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6></a><a href=#__codelineno-29-6><span class=linenos data-linenos=" 6 "></span></a>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7></a><a href=#__codelineno-29-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=c1>// Map from (src-thr,src-val) to bit</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8></a><a href=#__codelineno-29-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>SrcLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_32</span><span class=p>,</span><span class=n>_128</span><span class=o>&gt;</span><span class=p>,</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9></a><a href=#__codelineno-29-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>                            </span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_128</span><span class=p>,</span><span class=w>  </span><span class=n>_1</span><span class=o>&gt;&gt;</span><span class=p>;</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10></a><a href=#__codelineno-29-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=c1>// Map from (dst-thr,dst-val) to bit</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11></a><a href=#__codelineno-29-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>DstLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Layout</span><span class=o>&lt;</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=n>_32</span><span class=p>,</span><span class=n>Shape</span><span class=w> </span><span class=o>&lt;</span><span class=n>_32</span><span class=p>,</span><span class=w>   </span><span class=n>_4</span><span class=o>&gt;&gt;</span><span class=p>,</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12></a><a href=#__codelineno-29-12><span class=linenos data-linenos="12 "></span></a><span class=w>                            </span><span class=n>Stride</span><span class=o>&lt;</span><span class=n>_32</span><span class=p>,</span><span class=n>Stride</span><span class=o>&lt;</span><span class=w> </span><span class=n>_1</span><span class=p>,</span><span class=n>_1024</span><span class=o>&gt;&gt;&gt;</span><span class=p>;</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13></a><a href=#__codelineno-29-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14></a><a href=#__codelineno-29-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=c1>// Reference map from (thr,val) to bit</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15></a><a href=#__codelineno-29-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>RefLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DstLayout</span><span class=p>;</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16></a><a href=#__codelineno-29-16><span class=linenos data-linenos="16 "></span></a><span class=p>};</span>
</span></code></pre></div> <p>我们把 src layout 和 dst layout 都打出来看，由于所使用的 data type 为 half，所以 src layout 和 dst layout 转化为 <code>(t, v) -&gt; logical mem id</code> 映射</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20250811162318861.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20250811162318861.png alt=image-20250811162318861 style=zoom:50%;></a></p> <p>上面的打印中相同的数字代表了相同的 logical mem id，即他们代表了统一个元素。可以看到在 src 当中的 t0 拥有数据 0~7，他们分别分配到了 dst 当中的 t0~t3 中的前两个 values 当中。而对于 dst 当中的 t0 数据则来自于 t0, t8, t16, t24 的前两个 values</p> <p>为什么我始终强调逻辑位置 logical mem id，这是因为这些元素在内存中的位置与逻辑位置并不一致。最重要的是：<strong>根据 logical memory id 我们可以构建一个 src tv -&gt; dst tv 的映射关系，从而能够轻松获得 src tv 中的元素在 dst tv 当中的位置</strong></p> <h4 id=how-to-build>How to build?<a class=headerlink href=#how-to-build title="Permanent link">¶</a></h4> <p>构建 tiled copy 的双核心逻辑</p> <ol> <li>对于使用 universal copy 的场景，直接使用 <code>make_tiled_copy</code> 构建所需的 mn shape，从而直接定义一个 cta block 的 copy 能力</li> <li> <p>对于 tv layouts 有特殊要求的 copy 场景（e.g. mma），此时需要考虑的是 tv layouts 与 copy atom 之间的合法性问题，即 copy atom 的整除要求（size of v 需要至少为 8）。此时一个 cta block 的 copy 能力是 mma atom mn shape 的重复，可通过 permutation mnk 参数进行调整</p> <p>对于 sm90 之后该问题不用考虑，mma 与 copy 之间的合法性总是能够得到满足，我们无需考虑 mma atom 需要重复几次以满足 copy 要求，只需要关注 cta tile 与 mma atom 之间的整除关系是否满足即可</p> </li> </ol> <p>考虑好了以上两个核心逻辑就可以清晰地计算 tiled copy 中的三个核心参数：copy atom, tiled tv layout, mn shape</p> <p>此时一个大的 picture 正在浮现开来：<strong>tile centric CUDA programming</strong>。核心问题：<strong>What kinds of tile you want to choose to solve a cta problem?</strong></p> <p>对于 smem -&gt; rmem 这个环节当中，我们利用 mma atom mn shape 作为基础的 building block，为了配合 copy atom 合法性，我们对其 mnk tile 进行了相应的重复，最终<strong>构建出实际使用的 mnk tile</strong>，cta problem 将由这个 tile 进行切分解决</p> <h3 id=_5>重要补充材料<a class=headerlink href=#_5 title="Permanent link">¶</a></h3> <p><strong>补充（2025/09/17）：retile 到底要解决一个什么样的问题？结论：解决线程 register 的 layout 转换问题</strong></p> <p>我们在思考 copy 的问题时，其实还是更容易从整体去思考，例如把一个 MN shape 的数据进行划分，每一个线程获得各自的数据，然而最后我们都是面向 thread 编程，各个线程的 register 数据都是各自独立（互不可见）的，我们必须要将自己的视角进行转换。以下有三个划分视角：</p> <p>对于一个 MN shape 数据</p> <ol> <li> <p>我们可以使用 mma atom 的 layout 对 MN shape 的数据进行划分，每一个线程的数据 <code>tCrC_0</code></p> <p>假设 mma atom layout 的 mn shape 为 <code>(m, n)</code>，每一个 thread 有 4 个 values，那么 <code>tCrC_0.shape = (4, M//m, N//n)</code></p> </li> <li> <p>我们可以使用 s2r copy atom 的 layout 对 MN shape 的数据进行划分，每一个线程的数据 <code>tCrC_1</code></p> <p>假设 s2r copy atom 的 mn shape 为 <code>(2m, n)</code>，每一个 thread 有 8 个 values，那么 <code>tCrC_1.shape = (8, M//2m, N//n)</code> </p> </li> <li> <p>我们可以使用 r2s copy atom 的 layout 对 MN shape 的数据进行划分，每一个线程的数据为 <code>tCrC_2</code></p> <p>假设 r2s copy atom 的 mn shape 为 <code>(m, 2n)</code>，每一个 thread 有 8 个 values，那么 <code>tCrC_1.shape = (8, M//m, N//2n)</code></p> </li> </ol> <p>以上三种划分，最终得到了三种数据 <code>tCrC_0/1/2</code>，而这<strong>三种数据实际上包含了相同的数据内容</strong>，更具体来说，这三个 tensor 的 <code>tensor.data()</code>，指向的是同一片内存，但是他们的排布 <code>tensor.layout()</code> 完全不同。实际上 retile 干的事情就是这样，把相同拥有相同 data 的 tensor 转换为所需要的 layout，本质上就是做了这么一件事</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1></a><a href=#__codelineno-30-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// retile A tensor to B tensor's layout</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2></a><a href=#__codelineno-30-2><span class=linenos data-linenos="2 "></span></a><span class=n>A_retiled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_tensor</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span><span class=w> </span><span class=n>B</span><span class=p>.</span><span class=n>layout</span><span class=p>())</span>
</span></code></pre></div> <p>但是这个 B 的 layout 计算有时候并不是那么明显的，所以 retile 将 B layout 计算都隐藏起来了。拥有了 retile 过后，就能够在各个形态进行丝滑转换，我们无论是在进行 mma 计算，还是在进行数据 copy，就可以构建同一份 register 数据的不同排布，以确保在 <code>cute::copy &amp; cute::gemm</code> 在进行坐标 index 的时候获得了正确的数据</p> <p>我之前对于 retile &amp; tiled copy 没有那么熟，所以认为要用更多的概念来进行区分。实际上从始至终，我们都是在 block level 上进行编程，更多由重复所带来的功能，都可以由 <code>cute::gemm &amp; cute::copy</code> 进行完成。而由于 copy &amp; mma block 之间，对数据的划分各有不同，所以产生了对数据 layout 的操作转换，这带来了极大的学习困难</p> <p><strong>补充（2025/10/28）：retile solved by compose &amp; inverse</strong></p> <p><a href=https://zhuanlan.zhihu.com/p/1962625273636845008>写给大家看的 CuTe 教程：Layout compose &amp; Inverse</a> 受到其中的例子启发，我又重新审视了一下 retile，并且更深入地对 product/divide 和 inverse 进行了练习，获得了一些不错的经验。现在对 retile 问题进行更具体的阐述：</p> <p>Condition：对于一个 gmem tensor x，使用了两种 partition 方式（e.g. 不一样大小的 tiler），<code>partition_A</code> &amp; <code>partition_C</code>，划分过后每个线程所获得的数据分别为 <code>gA</code> 和 <code>gC</code>，并且已经申请了 register <code>rA = make_fragment_like&lt;AType&gt;(gA)</code> 用于 copy <code>gA</code></p> <p>Target：以最小代价构建 <code>rC</code></p> <p>有三个不一样的思路（包含错误思路），我都来分析一下：</p> <ol> <li> <p>直接使用 <code>gC</code> 的 shape 和 <code>rA</code> 的数据</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1></a><a href=#__codelineno-31-1><span class=linenos data-linenos="1 "></span></a><span class=n>rC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_tensor</span><span class=p>(</span><span class=n>rA</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>gC</span><span class=p>.</span><span class=n>shape</span><span class=p>()))</span>
</span></code></pre></div> <p>这显然是行不通的，<code>gC</code> shape 所生成的 layout 是一个 natural layout，其 stride 和真正的 <code>rC</code> 是不一样的</p> </li> <li> <p>使用 <code>make_fragment_like</code> 构建 <code>rC</code></p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1></a><a href=#__codelineno-32-1><span class=linenos data-linenos="1 "></span></a><span class=n>rC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_fragment_like</span><span class=o>&lt;</span><span class=n>AType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>gC</span><span class=p>)</span>
</span></code></pre></div> <p>该方法的确能够获得正确的 <code>rC</code> layout，但是会额外申请寄存器，造成资源浪费。如果我们知道 <code>make_fragment_like</code> 计算 <code>rC</code> layout 的方法也是可行的</p> </li> <li> <p>构建 <code>gC coord -&gt; gA coord</code> 的映射，利用 compose 获得 <code>rC coord -&gt; offset</code> 映射，该映射即为正确的 <code>rC</code> layout</p> <p>首先我们来看几个 tensor layout 所代表的映射</p> <ul> <li><code>gA</code> layout 是 <code>gA coord -&gt; gmem offset</code>，即 tensor coordinate 到 gmem offset 的映射</li> <li><code>gC</code> layout 是 <code>gC coord -&gt; gmem offset</code>，类似 <code>gA</code></li> <li><code>rA</code> layout 是 <code>rA coord -&gt; rmem offset</code>，即 tensor coordinate 到 register offset 的映射，其中 <code>rA</code> 的 shape 和 <code>gA</code> 是一致的</li> <li><code>rC</code> layout 是 <code>rC coord -&gt; rmem offset</code>，类似 <code>rA</code></li> </ul> <p>我们构建 <code>gC coord -&gt; gA coord</code> 的桥梁就是：<code>gA &amp; gC</code> 有着相同的 gmem offset domain，即他们的数据是一样的，此时我们可以通过 inverse + compose 构建映射</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1></a><a href=#__codelineno-33-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// gmem offset -&gt; gA coord</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2></a><a href=#__codelineno-33-2><span class=linenos data-linenos="2 "></span></a><span class=n>inv_gA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>left_inverse</span><span class=p>(</span><span class=n>gA</span><span class=p>)</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3></a><a href=#__codelineno-33-3><span class=linenos data-linenos="3 "></span></a><span class=c1>// gC coord -&gt; gA coord </span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4></a><a href=#__codelineno-33-4><span class=linenos data-linenos="4 "></span></a><span class=n>gC_to_gA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inv_gA</span><span class=p>.</span><span class=n>compose</span><span class=p>(</span><span class=n>gC</span><span class=p>)</span><span class=w> </span><span class=c1>// gC -&gt; gmem -&gt; gA</span>
</span></code></pre></div> <p>有了 <code>gC -&gt; gA</code> 的映射过后，直接利用 compose <code>gA -&gt; rmem offset</code> 的映射即可完成 <code>gC -&gt; rmem offset</code> layout 的构建，因为 <code>gC</code> 和 <code>rC</code> 有相同的 shape，所以得到的就是 <code>rC</code> 的 layout</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1></a><a href=#__codelineno-34-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// rA &amp; gA has the same shape</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2></a><a href=#__codelineno-34-2><span class=linenos data-linenos="2 "></span></a><span class=c1>// gC -&gt; (gA = rA) -&gt; rmem offset</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3></a><a href=#__codelineno-34-3><span class=linenos data-linenos="3 "></span></a><span class=n>rC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rA</span><span class=p>.</span><span class=n>compose</span><span class=p>(</span><span class=n>gC_to_gA</span><span class=p>)</span>
</span></code></pre></div> </li> </ol> <p><strong>补充（2025/10/31）：mma tv layout solved by product &amp; inverse</strong></p> <p>以上例子都需要有一个前提：不同的 partition 过后，thread 所获得的数据都是相同的。这个前提如何确保满足？我开始对 mma layout 进行了更多的研究，我发现 mma layout 只不过是同一种模式的复制粘贴：不断地重复一个 8x8 的 tile，其 tv layout 可写作</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1></a><a href=#__codelineno-35-1><span class=linenos data-linenos="1 "></span></a><span class=c1># tv -&gt; mn</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2></a><a href=#__codelineno-35-2><span class=linenos data-linenos="2 "></span></a><span class=n>mma_basic_layout</span> <span class=o>=</span> <span class=n>Layout</span><span class=p>(</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3></a><a href=#__codelineno-35-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4></a><a href=#__codelineno-35-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>stride</span><span class=o>=</span><span class=p>[</span><span class=mi>16</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=p>]</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5></a><a href=#__codelineno-35-5><span class=linenos data-linenos="5 "></span></a><span class=p>)</span>
</span></code></pre></div> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20251104210802954.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20251104210802954.png alt=image-20251104210802954 style=zoom:50%;></a></p> <p>我们可以模仿 <code>make_tiled_copy</code> 中的方式，推导出这个 tv -&gt; mn layout</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1></a><a href=#__codelineno-36-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// (m1, n1) -&gt; tid</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2></a><a href=#__codelineno-36-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>mn2tid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_8</span><span class=p>{},</span><span class=w> </span><span class=n>_4</span><span class=p>{}),</span><span class=w> </span><span class=n>make_stride</span><span class=p>(</span><span class=n>_4</span><span class=p>{},</span><span class=w> </span><span class=n>_1</span><span class=p>{}));</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3></a><a href=#__codelineno-36-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1>// (m2, n2) -&gt; vid</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4></a><a href=#__codelineno-36-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>mn2vid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_1</span><span class=p>{},</span><span class=w> </span><span class=n>_2</span><span class=p>{}),</span><span class=w> </span><span class=n>make_stride</span><span class=p>(</span><span class=n>_0</span><span class=p>{},</span><span class=w> </span><span class=n>_1</span><span class=p>{}));</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5></a><a href=#__codelineno-36-5><span class=linenos data-linenos=" 5 "></span></a>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6></a><a href=#__codelineno-36-6><span class=linenos data-linenos=" 6 "></span></a><span class=c1>// ((m2, m1), (n2, n1)) -&gt; (tid, vid)</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7></a><a href=#__codelineno-36-7><span class=linenos data-linenos=" 7 "></span></a><span class=c1>// raked product to make v comes first</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8></a><a href=#__codelineno-36-8><span class=linenos data-linenos=" 8 "></span></a><span class=c1>// ((_1,_8),(_2,_4)):((_0,_4),(_32,_1))</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9></a><a href=#__codelineno-36-9><span class=linenos data-linenos=" 9 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>mn2tv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>raked_product</span><span class=p>(</span><span class=n>mn2tid</span><span class=p>,</span><span class=w> </span><span class=n>mn2vid</span><span class=p>);</span><span class=w> </span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10></a><a href=#__codelineno-36-10><span class=linenos data-linenos="10 "></span></a>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11></a><a href=#__codelineno-36-11><span class=linenos data-linenos="11 "></span></a><span class=c1>// inverse &amp; with shape</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12></a><a href=#__codelineno-36-12><span class=linenos data-linenos="12 "></span></a><span class=c1>// (tid, vid) -&gt; (m, n)</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13></a><a href=#__codelineno-36-13><span class=linenos data-linenos="13 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>tv2mn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>left_inverse</span><span class=p>(</span><span class=n>mn2tv</span><span class=p>).</span><span class=n>with_shape</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_32</span><span class=p>{},</span><span class=w> </span><span class=n>_2</span><span class=p>{}));</span>
</span></code></pre></div> <p>其中 inverse 过后，如何确保 <code>with_shape</code> 一定是正确的？万一 inverse 过后的 shape 是 <code>(vid, tid)</code> 呢？不会，一定会是 <code>(tid, vid)</code>，这是由于 product &amp; inverse 的性质所决定的：</p> <ol> <li>product 中，mn2vid 中的维度所对应的 stride 一定是被 multiply 的一方，这就决定了 vid 对应的 stride 会是最大的</li> <li>inverse 过后 stride 最大的 shape 会在最后（请回看 inverse 的推导过程）</li> </ol> <p>两个性质决定了 inverse 过后一定会是 <code>(tid, vid)</code> 的排列顺序，所以我们用 <code>with_shape</code> 能够很方便进行 reshape</p> <p>现在得到了 mma 中的 basic tv -&gt; mn layout，那么上图中重复 4 次的 tv -&gt; mn layout 如何得到？很简单，我们在其中使用一个 blocked product 重复 4 次即可</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1></a><a href=#__codelineno-37-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// repeat (2, 2) mn -&gt; tv</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2></a><a href=#__codelineno-37-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>mn2tv_4x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blocked_product</span><span class=p>(</span><span class=n>mn2tv</span><span class=p>,</span><span class=w> </span><span class=n>make_layout</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_2</span><span class=p>{},</span><span class=w> </span><span class=n>_2</span><span class=p>{})));</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3></a><a href=#__codelineno-37-3><span class=linenos data-linenos="3 "></span></a><span class=c1>// inverse to get (t, v, 2, 2) -&gt; (m, n)</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4></a><a href=#__codelineno-37-4><span class=linenos data-linenos="4 "></span></a><span class=c1>// give all the repeat to v</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5></a><a href=#__codelineno-37-5><span class=linenos data-linenos="5 "></span></a><span class=c1>// ((_4,_8),(_2,_2,_2)):((_32,_1),(_16,_8,_128))</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6></a><a href=#__codelineno-37-6><span class=linenos data-linenos="6 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>tv2mn_2x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>left_inverse</span><span class=p>(</span><span class=n>mn2tv_2x</span><span class=p>).</span><span class=n>with_shape</span><span class=p>(</span><span class=n>make_shape</span><span class=p>(</span><span class=n>_32</span><span class=p>{},</span><span class=w> </span><span class=n>_8</span><span class=p>{}));</span>
</span></code></pre></div> <p>正如 product 和 inverse 的性质导致，重复的 mode 会在 inverse 之后的 shape 排在最后。我们有一个 <code>(2, 2)</code> 的 blocked product，不过我们到底是重复 4 次 t，还是重复 4 次 v，还是 tv 各自重复两次？这就需要根据需求进行 permute &amp; reshape，在此情形下，是将 v 重复 4 次，所以直接用 with shape 即可，最后得到的 layout 和 mma traits 中的 layout 一模一样👏</p> <p>除了上述重复方法外，还有一个方法，参考自 <code>mma_atom.hpp</code> 当中的 <code>thrfrg_A</code>：从扩张过后的 MN -&gt; MN tensor 开始，利用 zipped divide 获得 tensor <code>(AtomM, AtomN), (RestM, RestN)</code>，然后利用 compose atom tv layouts 获得 <code>(t, v), (RestM, RestN)</code> layout，最后通过简单的 flatten &amp; group 也可获得正确的 layout</p> <p><code>with_shape</code> 的实现本质是一个 compose，这也指导我们，reshape 可以使用 compose 直接完成，尤其是对某一个 mode 做 reshape 的时候可以用 <code>compose(_, layout, ...)</code> 来跳过其他 mode。注意当 <code>layout.compose()</code> 传入多个 layout 的时候会自动使用 <code>make_tile(layouts)</code> 进行 by mode compose。所以对于 nested layout 中的某一个 mode 进行 reshape 时，也应当使用 <code>make_tile</code></p> <p>然而对于 permute 没有优雅的方法，只有老老实实构建新的 tensor 了</p> <ul> <li> <p><code>_</code> 在 product, divide, compose 当中的作用</p> <p>在 compose 当中其实就是跳过某个 mode，另外没有 <code>make_layout(_ ,)</code></p> <p>divide，只有 <code>logical_divide(_, shape, ...)</code> 是跳过某一个 mode，其他的 divide 都很难成功，<code>zipped_divide</code> 只有针对两个 shape 的时候才会成功</p> <p>product 无法使用 <code>_</code> 进行跳过，不然 <code>_</code> 会直接进入到 shape 当中，可以使用乘 1 的方式来跳过，最后使用 with shape 进行整合</p> </li> </ul> <p><strong>Copy 连续性要求</strong></p> <p>我们通常不会考虑 copy 的连续性要求，因为由于 copy 与使用场景的强绑定性，连续性要求都是会被满足的，不过在此我仍然以 ldmatrix 为例子，看下该要求的基本形式。ldmatrix 其实是要求 src tv 中每一个 thread 所拥有的 8 个 values 在 shared memory 中是连续的。这种约束也存在在 universal copy 当中</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1></a><a href=#__codelineno-38-1><span class=linenos data-linenos="1 "></span></a><span class=k>using</span><span class=w> </span><span class=n>R2SCopyAtomC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Copy_Atom</span><span class=o>&lt;</span><span class=n>UniversalCopy</span><span class=o>&lt;</span><span class=n>cute</span><span class=o>::</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span><span class=w> </span><span class=c1>// 16-bit contiguous</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2></a><a href=#__codelineno-38-2><span class=linenos data-linenos="2 "></span></a><span class=k>using</span><span class=w> </span><span class=n>R2SCopyAtomC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Copy_Atom</span><span class=o>&lt;</span><span class=n>UniversalCopy</span><span class=o>&lt;</span><span class=n>cute</span><span class=o>::</span><span class=kt>uint32_t</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span><span class=w> </span><span class=c1>// 32-bit contiguous</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3></a><a href=#__codelineno-38-3><span class=linenos data-linenos="3 "></span></a><span class=k>using</span><span class=w> </span><span class=n>R2SCopyAtomC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Copy_Atom</span><span class=o>&lt;</span><span class=n>UniversalCopy</span><span class=o>&lt;</span><span class=n>cute</span><span class=o>::</span><span class=kt>uint64_t</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span><span class=w> </span><span class=c1>// 64-bit contiguous</span>
</span></code></pre></div> <p>可以从 ldmatrix 中的 src tv 与 dst tv 之间的映射找到如下关系</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1></a><a href=#__codelineno-39-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>DST</span>                     <span class=n>SRC</span>      
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2></a><a href=#__codelineno-39-2><span class=linenos data-linenos=" 2 "></span></a><span class=o>----------------------------</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3></a><a href=#__codelineno-39-3><span class=linenos data-linenos=" 3 "></span></a><span class=n>T0</span><span class=o>~</span><span class=n>T3</span>    <span class=n>V0</span><span class=o>~</span><span class=n>V1</span> <span class=o>&lt;=&gt;</span> <span class=n>T0</span>  <span class=n>V0</span><span class=o>~</span><span class=n>V7</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4></a><a href=#__codelineno-39-4><span class=linenos data-linenos=" 4 "></span></a><span class=n>T4</span><span class=o>~</span><span class=n>T7</span>    <span class=n>V0</span><span class=o>~</span><span class=n>V1</span> <span class=o>&lt;=&gt;</span> <span class=n>T1</span>  <span class=n>V0</span><span class=o>~</span><span class=n>V7</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5></a><a href=#__codelineno-39-5><span class=linenos data-linenos=" 5 "></span></a><span class=o>...</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6></a><a href=#__codelineno-39-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>T28</span><span class=o>~</span><span class=n>T31</span>  <span class=n>V0</span><span class=o>~</span><span class=n>V1</span> <span class=o>&lt;=&gt;</span> <span class=n>T7</span>  <span class=n>V0</span><span class=o>~</span><span class=n>V7</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7></a><a href=#__codelineno-39-7><span class=linenos data-linenos=" 7 "></span></a><span class=o>----------------------------</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8></a><a href=#__codelineno-39-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>T0</span><span class=o>~</span><span class=n>T3</span>    <span class=n>V2</span><span class=o>~</span><span class=n>V3</span> <span class=o>&lt;=&gt;</span> <span class=n>T8</span>  <span class=n>V0</span><span class=o>~</span><span class=n>V7</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9></a><a href=#__codelineno-39-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>T4</span><span class=o>~</span><span class=n>T7</span>    <span class=n>V2</span><span class=o>~</span><span class=n>V3</span> <span class=o>&lt;=&gt;</span> <span class=n>T9</span>  <span class=n>V0</span><span class=o>~</span><span class=n>V7</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10></a><a href=#__codelineno-39-10><span class=linenos data-linenos="10 "></span></a><span class=o>...</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11></a><a href=#__codelineno-39-11><span class=linenos data-linenos="11 "></span></a><span class=n>T28</span><span class=o>~</span><span class=n>T31</span>  <span class=n>V2</span><span class=o>~</span><span class=n>V3</span> <span class=o>&lt;=&gt;</span> <span class=n>T15</span> <span class=n>V0</span><span class=o>~</span><span class=n>V7</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12></a><a href=#__codelineno-39-12><span class=linenos data-linenos="12 "></span></a><span class=o>----------------------------</span>
</span></code></pre></div> <p>用语言描述一下第一行：dst T0~T3 线程的 V0~V1 数据，对应了 src T0 线程的 V0~V7 数据。对于 ldmatrix 而言，其要求 src thread 中的 V0~V7 在内存中是连续的。OK，现在我们就用 mma atom 的 tv layout 来实际看一下，其 src thread 中的 V0~V7 是否真的连续。以 <code>SM80_16x8x16_F16F16F16F16_TN</code> 中的 matrix A 的 (dst) tv layout 为例，用 <code>print_latex</code> 打出来得到如下排布</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20250811163804449.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20250811163804449.png alt=image-20250811163804449 style="zoom: 33%;"></a></p> <p>我们可以发现 T0~T3 的 V0~V1 数据，正好是横向连续的 MK 坐标，这也说明了 T0 线程的 V0~V7 就是连续的 MK 坐标，但是为了保证内存的连续，MK -&gt; Memory 的映射必须是 LayoutRight 即 row-major 排布内存，否则这些横向连续的 MK 坐标所对应的数据在内存仍然不连续</p> <p>综上，在所给的 ldmatrix + mma layout + tensor layout 的条件下，copy 的连续性得到了满足。这也凸显出了三者的高度定制性：ldmatrix 必须和匹配的 mma layout 以及匹配的 tensor layout 进行使用，否则将会报错</p> <p><strong>Async Copy</strong></p> <p>在进行 copy 的时候经常会使用异步的 copy，即发出命令过后不会等待 copy 完成而是会继续执行后面的代码。但是我们也需要一些等待指令，以保证在计算时数据的确已经 copy 完成了。cutlass 提供了两个结构 <code>cp_async_fence &amp; cp_async_wait</code> 用于完成这样的操作，在之后的 hgemm 实践中会有具体表现，这里先仅二者的功能</p> <p><code>cp_async_fence</code></p> <ul> <li>这是一个内存屏障（fence）操作，用于标记当前所有已提交的异步拷贝（<code>cp.async</code>）任务的完成点。</li> <li>它的作用是确保在该 <code>fence</code> 之前的所有 <code>cp.async</code> 操作（即从全局内存到共享内存的异步拷贝）被视为一个批次，后续的 <code>cp.async_wait</code> 可以对这些批次进行同步。</li> <li>它并不阻塞线程，只是标记一个任务提交的边界。</li> </ul> <p><code>cp_async_wait</code></p> <ul> <li>这是一个同步操作，用于等待之前提交的异步拷贝任务完成。</li> <li>参数 <code>N</code> 表示“等待除了最新的 <code>N</code> 个批次之外的所有批次完成”。例如：<ul> <li><code>cp_async_wait&lt;0&gt;</code>：等待所有之前提交的异步拷贝完成。</li> <li><code>cp_async_wait&lt;1&gt;</code>：允许最多 1 个批次的异步拷贝未完成（即等待除最新提交的 1 个批次外的其他所有批次完成）。</li> </ul> </li> <li>通常用于实现流水线的同步，确保数据在计算之前已经加载到共享内存。</li> </ul> <h2 id=_6>核心优化<a class=headerlink href=#_6 title="Permanent link">¶</a></h2> <h3 id=double-buffer>多级流水线 (Double Buffer)<a class=headerlink href=#double-buffer title="Permanent link">¶</a></h3> <p>多级流水线在 <a href=https://zhuanlan.zhihu.com/p/665082713>cute 之 GEMM流水线</a> 中已经介绍地比较完善了，我这里将其中译中一下</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/v2-f9c13c984a5d8364e2d67e592cf7ddbf_1440w.jpg data-desc-position=bottom><img src=CUDA%20Programming%208.1/v2-f9c13c984a5d8364e2d67e592cf7ddbf_1440w.jpg alt=img style=zoom:67%;></a></p> <p>解释图中各个模块的含义：</p> <ol> <li> <p>浅绿色长方形代表：全局内存到共享内存的数据搬运<span class=arithmatex>\(G^i \rightarrow S^i\)</span>，上标<span class=arithmatex>\(i\)</span>代表的是第<span class=arithmatex>\(i\)</span>个 Tile 的数据（我称之为大 k 循环）</p> </li> <li> <p>浅橙色长方形代表：共享内存到寄存器的数据搬运<span class=arithmatex>\(S_j \rightarrow R_j\)</span>，下标<span class=arithmatex>\(j\)</span>代表的是第<span class=arithmatex>\(j\)</span>个小 k 循环（Tile 内循环）</p> </li> <li> <p>深绿色的长方形代表：TiledMMA 利用寄存器上的数据进行矩阵计算</p> </li> <li> <p>黑色实线之间代表：完成一个 Tile 的矩阵运算（完整的小 k 循环）。并且黑色实线上方使用了曲线虚线进行了连接，代表完成了一个 Tile 计算之后继续计算下一个 Tile</p> </li> <li> <p>黑色虚线代表：进行 <code>cp_async_wait</code>，等待 shared memory 搬运完毕</p> </li> </ol> <p>整个流水线的关键步骤：</p> <ol> <li> <p>首先将 <code>Stage - 1</code> 个全局内存到共享内存的加载任务异步地发布出去（发布过后不进行等待，直接执行之后的任务）</p> </li> <li> <p>等待<span class=arithmatex>\(S^0\)</span>的数据完成加载</p> </li> <li> <p>在进入小 k 循环之前，首先从<span class=arithmatex>\(S^0\)</span>中取出第一个小 k 循环所需要的数据，将其发送到寄存器上<span class=arithmatex>\(S_0\rightarrow R_0\)</span></p> </li> <li> <p>此时正式进入到小 k 循环，可以分为 4 个要点：</p> <ol> <li>发射异步读取新 Tile 的任务请求，即图中的<span class=arithmatex>\(G^3 \rightarrow S^3\)</span></li> <li>从共享内存中异步读取下一个小 k 循环所需要的数据<span class=arithmatex>\(S_j\rightarrow R_j\)</span></li> <li>执行第一个小 k 循环矩阵运算</li> <li>重复步骤 2~3 直到当前小 k 循环完成</li> </ol> <p>需要注意的是，在做最后一个小 k 循环时，我们需要读取下一个 Tile 中的第一个小 k 循环数据，该操作需要使用 <code>cp_async_wait</code> 来保证下一 Tile 的数据已经完全加载到 shared memory 当中。这也是图中的虚线所表达的含义</p> </li> </ol> <p>我们也经常听说 double buffer 这个词，其实就是多级流水线的一个特例，即流水线的级数等于 2，级数数量就等于 buffer 数量。在上图所示的流水线中，shared memory 流水线级数为 4，register memory 流水线级数为 5</p> <h3 id=swizzle>Swizzle<a class=headerlink href=#swizzle title="Permanent link">¶</a></h3> <p><a href=https://zhuanlan.zhihu.com/p/671419093>cute 之 Swizzle</a> 已经将 swizzle 将得特别清楚了。这段话极其本质</p> <blockquote> <p>回顾之前的介绍我们知道描述逻辑空间我们可以使用 <a href=https://zhuanlan.zhihu.com/p/661182311>Layout（本质是函数）</a>，而为了避免 bank 冲突，cute 中定义了 swizzle 抽象，swizzle 的本质也是函数，swizzle 作用在 layout 上，即函数作用在函数上，复合函数复合的定义。Layout 的作用是给定坐标返回 offset，而 swizzle 的作用则是给定 offset 返回 bank conflict free 的 offset。即</p> <div class=arithmatex>\[ offset_{\text{no-conflict}}=Swizzle(Layout(coord)) \]</div> </blockquote> <p>通过 swizzle 获得了新的 layout，将 (M, N) -&gt; offset 的位置进行改变。所以当在进行 read &amp; write 时，会将数据读写到 swizzled position 从而避免 bank conflict</p> <p>并且 swizzle (晃动/摇动) 这个名字特别的形象，想象你正在向 tensor <code>x</code> 的某个 coord <code>(m, n)</code> 写入数据</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1></a><a href=#__codelineno-40-1><span class=linenos data-linenos="1 "></span></a><span class=n>x</span><span class=p>(</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>1.0</span>
</span></code></pre></div> <p>它本来该在 <code>layout(coord)</code> 位置写入该数据，结果 swizzle 了一下，写到了 <code>swizzle(layout(coord))</code> 位置。物理位置对于读和写其实是无感的，因为读和写操作的是 tensor coord <code>(m, n)</code></p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1></a><a href=#__codelineno-41-1><span class=linenos data-linenos="1 "></span></a><span class=n>print</span><span class=p>(</span><span class=n>x</span><span class=p>(</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>))</span><span class=w>  </span><span class=c1>// 1.0</span>
</span></code></pre></div> <p>swizzle 不同于普通的 layout algebra，没办法用之前的 composition 来统一表达，但其本质仍然是函数映射。通过 M, B, S 三个参数来完全表示。最小单元为<span class=arithmatex>\(2^M\)</span>，而这个单元就是从 layout offset 顺序进行 group 和排序</p> <p>swizzle 似乎给我上面的连续性分析带来了矛盾：swizzle 会打乱数据的连续性，但如果以<span class=arithmatex>\(2^M\)</span>为单位的话，基本的连续性还是有保障的。例如<span class=arithmatex>\(2^3\)</span>为单位的话，那么连续 8 个数据则都会是连续的，这就能满足 ldmatrix 的连续性要求</p> <p>Swizzle 具体的计算过程在这里下不整理，在之后用 Swizzle 解决 bank conflict 处再详细说明，理解其意义，并且知道如何用 swizzle 来解决不同情况的 bank conflict</p> <h4 id=bank-conflict>Bank Conflict<a class=headerlink href=#bank-conflict title="Permanent link">¶</a></h4> <p>首先定义两个概念：</p> <ol> <li> <p>shared memory bank</p> <p>共享内存被划分为多个独立的、等宽的存储单元，称为 <strong>Bank</strong>。每个 Bank 的宽度：<strong>4 bytes（32-bit）</strong>（所有现代 NVIDIA GPU 均如此）。Bank 总数：<strong>32 个</strong>（对应一个 Warp 的 32 个线程）</p> <p>每个 Bank 可以独立读写，因此 <strong>32 个线程可以同时访问 32 个不同的 Bank</strong>（无冲突）。如果多个线程访问同一个 Bank 的不同地址，则发生 <strong>Bank Conflict</strong>，导致访问串行化</p> </li> <li> <p>phase</p> <p><strong>1 个 Phase</strong> = 硬件一次性完成的 <strong>128B 数据传输</strong>（32 Banks × 4B）</p> <p><strong>线程参与 Phase 的方式</strong>：</p> <table> <thead> <tr> <th style="text-align: left;">每个线程的请求位宽</th> <th style="text-align: left;">填满 128B 所需的线程数</th> <th style="text-align: left;">是否典型优化</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;">4B（32-bit）</td> <td style="text-align: left;">32 线程</td> <td style="text-align: left;">否（低效）</td> </tr> <tr> <td style="text-align: left;">8B（64-bit）</td> <td style="text-align: left;">16 线程</td> <td style="text-align: left;">部分场景</td> </tr> <tr> <td style="text-align: left;">16B（128-bit）</td> <td style="text-align: left;">8 线程</td> <td style="text-align: left;"><strong>是</strong>（最优）</td> </tr> </tbody> </table> <p><strong>为什么 8 线程 × 16B 是最优的？</strong></p> <ul> <li>减少指令数（1 条 <code>LDG.128</code> 代替 4 条 <code>LDG.32</code>）</li> <li>最大化带宽利用率（单次 Phase 完成更多数据搬运）</li> </ul> <p>bank conflict 考虑范围的是一个 phase 内，不会考虑两个 phase 或更多，因为同时考虑两个 phase 一定会产生 bank conflict，因为一个 phase 就把 bank 宽度填满了，两个 phase 中必定有不同线程指向相同的 bank</p> <p>正如本文之前所示的 ldmatrix 示意图，一个黑色方框 (8x8 half matrix) 就是一次 phase 读取</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/v2-5a2257c2bea9b2f6652cfe579444f3bb_720w.webp data-desc-position=bottom><img src=CUDA%20Programming%208.1/v2-5a2257c2bea9b2f6652cfe579444f3bb_720w.webp alt=img style=zoom:67%;></a></p> <p>update 2025/07/19 补充一下 <code>LDG.128</code> 与合并访问之间的关系</p> <blockquote> <p>From Kimi</p> <p><strong>LDG128 是向量化加载指令，天然利于合并访存</strong>。在 CUDA 中，<strong>一个 warp（32线程）如果使用 LDG.128 连续访问内存地址</strong>，则：</p> <ul> <li>每个线程请求 16 Byte；</li> <li>整个 warp 请求 32 × 16 = <strong>512 Byte</strong>；</li> <li>如果地址对齐且连续，这 512 Byte 可以合并为 <strong>4 次 128 Byte 的事务</strong>（512/128 = 4）。</li> </ul> <p>这<strong>极大提高了合并度（coalescing degree）</strong>，减少 memory transaction 数量，提升带宽利用率。</p> </blockquote> <p>使用4次 <code>LDG.32</code> 仍然可能仅使用在 4 次 128 Byte 的内存事务完成，但是相比 <code>LDG.128</code> 会使用更多的指令，这也会消耗更多的时间。所以尽可能使用 <code>LDG.128</code> 指令</p> </li> </ol> <p>在 reed zhihu 中有一个分析 bank conflict 的思路</p> <blockquote> <p>完整的512byte需要4个phase才能完成访问。<strong>这种情况也可以看作是：shared memory基本单元为16byte，总bank数为8，冲突与否的分析不在是32线程，而变成4个phase中的不同线程。如果采用64bit的访问形式，则相应的基本单元可以看作是8byte，总bank数目为16，冲突与否的条件变成两个phase内的线程是否冲突。</strong>整体上shared memory空间可以看作二维存储空间，其中列方向表示bank情况，行方向表示自由定义的大小。</p> </blockquote> <p>我们可以从不同的粒度来构建简化过后的 shared memory 模型，方便我们分析。用这个模型来分析一个 16x16 or 16x64 size 的矩阵读写</p> <p><strong>所以Bank Conflict数量其实可以等价的理解为，在一个Phase内需要额外多少访存次数</strong>。From <a href=https://www.zhihu.com/question/667972067/answer/43935974172>zhihu</a></p> <p>理解 swizzle 以及其使用需要对多个概念进行熟悉。网络上的教程每一个都有自己对 swizzle 的定义和理解，我结合了三篇 blog 总结出自己对 swizzle 的理解：</p> <ol> <li><a href=https://leimao.github.io/blog/CuTe-Swizzle/ >LeiMao-CuTe Swizzle</a>，最为严谨的 blog，给出了准确概念，并且有实际例子与计算过程，能够推导出一般 swizzle 参数的计算公式</li> <li><a href=https://zhuanlan.zhihu.com/p/32954684694>Swizzle 本质思考</a>，给出了逻辑行列和物理行列的思考模式</li> <li><a href=https://zhuanlan.zhihu.com/p/20579515046>实用 Swizzle 教程系列</a>，是第二篇 blog 的参考，我也列在这里</li> </ol> <p>我将按照用五个部分来叙述 swizzle 概念以及其使用方法，并在最后给出解决 bank conflict 的一般思路</p> <ol> <li> <p>Swizzle Arguments，介绍 swizzle 概念</p> </li> <li> <p>Introduce Examples，用例子来熟悉 swizzle 概念</p> </li> <li> <p>Logical &amp; Physical view，介绍逻辑 &amp; 物理的不同视角来看到 swizzle bits</p> </li> <li> <p>Common Examples，利用逻辑 &amp; 物理 offset 分析一些常见例子</p> </li> <li> <p>General Methods，给出一般解决思路</p> </li> </ol> <h4 id=swizzle-in-bits>Swizzle in Bits<a class=headerlink href=#swizzle-in-bits title="Permanent link">¶</a></h4> <p>cutlass swizzle 其实是按地址的 bit 来解释的，其注释写得其实很清楚，但很容易被其迷惑的排版给迷惑了</p> <div class="language-c++ highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1></a><a href=#__codelineno-42-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// A generic Swizzle functor</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2></a><a href=#__codelineno-42-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm>/* 0bxxxxxxxxxxxxxxxYYYxxxxxxxZZZxxxx</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3></a><a href=#__codelineno-42-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm>    *                               ^--^ MBase is the number of least-sig bits to keep constant</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4></a><a href=#__codelineno-42-4><span class=linenos data-linenos=" 4 "></span></a><span class=cm>    *                  ^-^       ^-^     BBits is the number of bits in the mask</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5></a><a href=#__codelineno-42-5><span class=linenos data-linenos=" 5 "></span></a><span class=cm>    *                    ^---------^     SShift is the distance to shift the YYY mask</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6></a><a href=#__codelineno-42-6><span class=linenos data-linenos=" 6 "></span></a><span class=cm>    *                                       (pos shifts YYY to the right, neg shifts YYY to the left)</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7></a><a href=#__codelineno-42-7><span class=linenos data-linenos=" 7 "></span></a><span class=cm>    *</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8></a><a href=#__codelineno-42-8><span class=linenos data-linenos=" 8 "></span></a><span class=cm>    * e.g. Given</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9></a><a href=#__codelineno-42-9><span class=linenos data-linenos=" 9 "></span></a><span class=cm>    * 0bxxxxxxxxxxxxxxxYYYxxxxxxxZZZxxxx</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10></a><a href=#__codelineno-42-10><span class=linenos data-linenos="10 "></span></a><span class=cm>    * the result is</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11></a><a href=#__codelineno-42-11><span class=linenos data-linenos="11 "></span></a><span class=cm>    * 0bxxxxxxxxxxxxxxxYYYxxxxxxxAAAxxxx where AAA = ZZZ xor YYY</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12></a><a href=#__codelineno-42-12><span class=linenos data-linenos="12 "></span></a><span class=cm>    */</span>
</span></code></pre></div> <p>swizzle 一共有3个参数：M, S, B。在 reed 的教程中分别解释为：基本单元包含的元素，一行包含的单位单元，有多少行。这当然是最直观的解释，不过现在我们要将这些参数用一般的 address 来看待。这里一个 address 是一个 32bit 的数据（可以数一下，上面注释一个地址包含了 32 个字母），下面是英译中</p> <ol> <li> <p><code>M or MBase</code>，保持不变的位数量</p> <p>例子中用了 4bit，代表着一个基本单元包含 16 个元素。其中的字母都是一个 bit 其值为 0 or 1</p> </li> <li> <p><code>B or BBits</code>，mask 当中的位数量</p> <p>例子中用了 3bit，我们可以将其直观解释为“行号”</p> </li> <li> <p><code>S or SShift</code>，需要位移的位数量</p> <p>例子中用了 10 bit，我们可以将其直观解释为“列号”</p> </li> </ol> <p>例子中的直观解释：一个基本单元包含 16 个元素，一行包含了 1024 个基本单元，一共有 8 行。在进行 swizzle 计算时，其实就是用行号 <code>YYY</code> 和列号 <code>ZZZ</code> 进行了异或操作，获得了新的列号 <code>AAA</code>。这里有一个隐藏的限制：<code>S &lt;= B</code>，否则无法有足够的位完成异或操作</p> <p>异或操作由于其封闭性和双射性会将数据进行完美的重排，即不会有多个数据排到相同位置，也不会有数据排布到规定范围之外。下面用一些基本的例子来看如何利用 swizzle 将数据进行重排，从而避免 bank conflict</p> <h4 id=introduce-examples>Introduce Examples<a class=headerlink href=#introduce-examples title="Permanent link">¶</a></h4> <p><strong>Example 1</strong></p> <p>读取一个 fp32 matrix 中的一列，matrix layout 为 <code>Layout(shape=[32, 128], stride=[128, 1])</code></p> <p>shared memory bank 一行能够装下 1024bit 的数据，矩阵的一行有 128 个 32bit 元素，会填满 4 行的 bank。假设我们读取第一列的数据，各个数据的 offset 根据 layout algebra 的运算为</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1></a><a href=#__codelineno-43-1><span class=linenos data-linenos="1 "></span></a><span class=mi>128</span> <span class=o>*</span> <span class=mi>0</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2></a><a href=#__codelineno-43-2><span class=linenos data-linenos="2 "></span></a><span class=mi>128</span> <span class=o>*</span> <span class=mi>1</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3></a><a href=#__codelineno-43-3><span class=linenos data-linenos="3 "></span></a><span class=mi>128</span> <span class=o>*</span> <span class=mi>2</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4></a><a href=#__codelineno-43-4><span class=linenos data-linenos="4 "></span></a><span class=o>...</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5></a><a href=#__codelineno-43-5><span class=linenos data-linenos="5 "></span></a><span class=mi>128</span> <span class=o>*</span> <span class=mi>31</span>
</span></code></pre></div> <p>由于 <code>offset % 32</code> 的结果都是 0，所以这些数据都会落在 bank0 的位置，会引起非常严重的 32-way bank conflict。读取其他列也是类似的情况</p> <p>不过我们可以通过 swizzle 来解决这一个问题：</p> <ol> <li><code>M = 0</code>，一个基本单位包含 1 个 fp32 元素</li> <li><code>S = 7</code>，一行包含 128 个基本单位</li> <li><code>B = 5</code>，一共有 32 行</li> </ol> <p>我们的 swizzle bit version表示如下</p> <div class=arithmatex>\[ \underline{xxxxx}\ yy\underline {yyyyy} \]</div> <p>第一列的列号为 <code>00000000</code>，32行的行号为 <code>00000~11111</code>，通过异或操作对应的 5bit 得到新的列号（公式中加下划线的部分）</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1></a><a href=#__codelineno-44-1><span class=linenos data-linenos="1 "></span></a><span class=mi>00000</span> <span class=n>xor</span> <span class=mi>00000</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2></a><a href=#__codelineno-44-2><span class=linenos data-linenos="2 "></span></a><span class=mi>00000</span> <span class=n>xor</span> <span class=mi>00001</span> <span class=o>=</span> <span class=mi>1</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3></a><a href=#__codelineno-44-3><span class=linenos data-linenos="3 "></span></a><span class=o>...</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4></a><a href=#__codelineno-44-4><span class=linenos data-linenos="4 "></span></a><span class=mi>00000</span> <span class=n>xor</span> <span class=mi>11111</span> <span class=o>=</span> <span class=mi>31</span>
</span></code></pre></div> <p>此时第一列的所有数据通过 swizzle 被分配到了 32 个不同的 bank，彻底解决了 bank conflict。其他列同理可证</p> <p><strong>Example 2</strong></p> <p>在 Example 1 的基础上，使用向量化内存读取（Vectoriezed Memory Access），让单个线程一次性读取或写入连续的多个数据元素。既然一个线程读取的数据变多了，那么一个 phase 所包含的线程数量就会减少。所以我们讨论的范围变为：用 8 个线程，每一个线程读取 4 个 fp32，即读取 matrix 当中的一个 (8, 4) 区域</p> <p>如果未经过 swizzle，那么就会产生 8-way bank conflict，每一个线程的起始地址都在相同的 bank 当中</p> <p>直接计算 swizzle 中的参数，就可以将这些在相同 bank 的地址，重排到其他地址当中<span class=arithmatex>\(\underline{xxx}\ yy\underline {yyy}\ zz\)</span></p> <ol> <li><code>M = 2</code> 一个基本单位包含 4 个 fp32 元素</li> <li><code>S = 5</code> 一行包含 32=(128/4) 个基本单位</li> <li><code>B = 3</code> 一共有 8 行</li> </ol> <p>另外再强调一个“显而易见”的事情：通常产生 bank conflict 的情况都是在访问“列”方向上，而不会出现在访问“行”方向上。因为一行中的数据本身就放在了不同的 bank 当中，并且我们讨论的范围还是一个 phase，即 32 个 bank 的总宽度，那么在访问连续的“行”数据时，一般是不会发生冲突的</p> <p>在以上两个例子中你会发现他们的 M + B 都等于 5，他们的 M + S 都等于 7，这并不是巧合，而是我们推导 Swizzle 所遵循的公式</p> <h4 id=logical-physical-view>Logical &amp; Physical view<a class=headerlink href=#logical-physical-view title="Permanent link">¶</a></h4> <p>这一节我将通过例子来介绍如何从逻辑视角转移到物理视角来解释如何计算 swizzle bits</p> <p><strong>Example 1</strong></p> <p>以一个 fp16 的 matrix 为例，其 matrix layout 为 <code>Layout(shape=[16, 16], stride=[16, 1])</code>，线程读取方式仍然是老图的左侧所示</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/v2-5a2257c2bea9b2f6652cfe579444f3bb_720w.webp data-desc-position=bottom><img src=CUDA%20Programming%208.1/v2-5a2257c2bea9b2f6652cfe579444f3bb_720w.webp alt=img style=zoom:67%;></a></p> <p>我们先写一个其逻辑上的 swizzle bits</p> <ol> <li><code>M = 3</code> 一个基本单位包含 8 个 fp16 元素，这里我们仍然假设是使用 128bit 向量化读取</li> <li><code>S = 1</code> 一行包含 2 个基本单位</li> <li><code>B = 4</code> 一共有 16 行</li> </ol> <p>用 swizzle bits 的方式来看</p> <div class=arithmatex>\[ xxxx\ y\ zzz \]</div> <p>但这样来看我们很难看出和 bank conflict 之间的关系。此时我们要以物理上的 swizzle bits 来看待。memory bank 一行有 1024bit 将包含 8 个基本元素，即 <code>S = 3</code>，再回到 Bank Conflict 小节的末尾，就能明白 reed 对于 bank 的一种逻辑抽象：此时我们可以认为一共有 8 个逻辑 bank</p> <p>我们将这个 swizzle bits 修改为如下：<code>B=2, S=3, M=3</code>，相当于从 B 挪了两个 bit 到 S 当中</p> <div class=arithmatex>\[ xx\ xxy\ zzz \]</div> <p>此时我们可以看到，<span class=arithmatex>\(xyy\)</span>这 3bit 就对应了 bank 的一整行，即 8 个逻辑 bank。当<span class=arithmatex>\(xxy=000\)</span>时就代表了逻辑 bank 0，此时对于前面两个 bit<span class=arithmatex>\(xx\)</span>的任意值，他们都属于同一个逻辑 bank，所以会产生 bank conflict！再从逻辑视角来看，每 4 行会占据一整行的 bank 宽度，第 0，4，8，12 行的数据都会落在同一个 bank 当中</p> <p>现在我们需要考虑线程读取的方式了，因为我们只考虑一个 phase 的读取，在本例当中，一个 phase 读取 (8, 8) 区域的矩阵，按照 swizzle bits 来算的话是 (8, 1) 个单位，即原来的<span class=arithmatex>\(xxxx\)</span>4bit 表示 16 行，我们现在只考虑 8 行<span class=arithmatex>\(xxx\)</span></p> <div class=arithmatex>\[ \cancel xx\ xxy\ zzz \]</div> <p>现在可以看到目前是第 0，4 行就会产生 2-way bank conflict，我们直接在这个位置上进行 xor 操作，把 bank conflict 解决</p> <div class=arithmatex>\[ \underline x \ xx\underline y\ zzz \]</div> <p>此时我们的 swizzle 表示为 <code>Swizzle&lt;B=1, S=3, M=3&gt;</code> 就可以把这些冲突给解开。不过如果我们并不是使用 ldmatrix 的读取方式，仍有可能读取不连续的 8 行，所以此时设置 <code>Swizzle&lt;B=2, S=3, M=3&gt;</code> 才能解决掉所有冲突</p> <div class=arithmatex>\[ \underline{xx} \ x\underline {xy}\ zzz \]</div> <p>需要注意的是，ldmatrix 也可以使用 <code>Swizzle&lt;B=2, S=3, M=3&gt;</code> 来解决冲突，本质上该 swizzle 解决冲突的能力更强。按此推理，我们继续增加 B，使用 <code>Swizzle&lt;B=3, S=3, M=3&gt;</code> 也能够完全解决冲突。然而 B 的增加并不是没有上限的，其受限于逻辑 bank 的总数。在本例当中逻辑 bank 一共有 8 个，如果 B 超过 3 则没有足够的逻辑 bank 用于分配。B 也没有必要超过逻辑 bank 的总数，因为一个 phase 的大小就是逻辑 bank 的总大小，我们只需要考虑一个 phase 内可能产生冲突的情况</p> <p><strong>Example 2</strong></p> <p>在 <strong>Example 1</strong> 当中我们读取的是一个 (16, 16) 的矩阵，那么如果我们读取的是一个 (16, 32) 大小的矩阵，也是一个 phase 读取 (8, 8) 区域大小的数据，应该采用怎样的 swizzle 呢？</p> <p>按照上面的分析我直接把这个 swizzle bits 写出</p> <div class=arithmatex>\[ \cancel x \underline{xx}\ x\underline{yy}\ zzz \]</div> <p>此时我们的 swizzle 表示为 <code>Swizzle&lt;B=2, S=3, M=3&gt;</code>，相比上一个例子多了一位的 mask bit，因为矩阵的一行会占一半的 bank，我们这样的读取方式会产生 4-way bank conflict，需要分配到 4 个不同的 bank 当中，所以 mask bit 需要为 2</p> <p>同样的 <code>Swizzle&lt;B=3, S=3, M=3&gt;</code> 也能够解决上述冲突</p> <h4 id=general-methods>General Methods<a class=headerlink href=#general-methods title="Permanent link">¶</a></h4> <p>接下来我将给出 Swizzle 的通用公式，modified from <a href=https://leimao.github.io/blog/CuTe-Swizzle/ >LeiMao-CuTe Swizzle</a></p> <p>Consitions：一个 phase 为 1024 bit，每个数据为 <code>k</code> bit，一行有 <code>X</code> 个，向量化读取一次读取 <code>V</code> 个元素</p> <p>Target：读取不同的列时不产生 bank conflict</p> <ol> <li> <p><code>M</code> 是最好计算的参数，根据向量化读取的情况决定</p> <div class=arithmatex>\[ M =\log_2{V} \]</div> </li> <li> <p><code>B</code> 按照解决冲突能力最强的 swizzle 来计算，即访问一个 phase 所有的 bank 都在同一个 logic bank 当中的情况</p> <div class=arithmatex>\[ B=\log_2{\frac{1024}{k}} - M \]</div> <p>超过一个 phase 的情况则不在考虑范围内，因为不同 phase 之间不产生冲突</p> </li> <li> <p><code>S</code> 的计算需要分情况讨论，这是因为 swizzle 要求 <code>S &gt;= B</code></p> <ol> <li> <p>一行数据 <code>X</code> 未占满 bank：<code>S</code> 和 <code>B</code> 相等</p> <div class=arithmatex>\[ S=\log_2{\frac{1024}{k}} - M \]</div> <p>此情况没有被 <a href=https://leimao.github.io/blog/CuTe-Swizzle/ >LeiMao-CuTe Swizzle</a> 所考虑，但是是必要的。其对应于上面例子中把<span class=arithmatex>\(x\)</span>移动到<span class=arithmatex>\(y\)</span>bit 部分，不会产生额外的 bank conflict，并满足 <code>S &gt;= B</code> 要求</p> </li> <li> <p>一行数据 <code>X</code> 已占满 bank：<code>S</code> 将计算一行元素会包含多少基本单元</p> <div class=arithmatex>\[ S=\log_2{X}-M \]</div> </li> <li> </li></ol> <p>所以两个公式合成一个公式</p> <div class=arithmatex>\[ S=\log_2{\max{(\frac{1024}{k},X)}} -M \]</div> </li> <li> </li></ol> <p><strong>该公式能够完美解决读取列数据产生 bank conflict 问题</strong></p> <p>不过还有一点我想要指出，以 fp16 的数据类型为例：如果一行数据很多，即 <code>X</code> 很多，那就需要大的 <code>S</code>，这意味着<span class=arithmatex>\(y\)</span>bit 位数增加</p> <div class=arithmatex>\[ \underline{xxx} \ yy\underline {yyy}\ zzz \]</div> <p>访问的<span class=arithmatex>\(y\)</span>bit 位置为 <code>00xxx or 01xxx or 10xxx or 11xxx</code> 时就会产生 bank conflict，他们都属于同一个逻辑 bank <code>xxx</code>。<strong>这是由于我们尝试一次读取不连续的行元素</strong>。如果我们总是读取连续的行元素，那么这种情况将不会发生，因为如果我们在读取连续的行元素时，如果出现了 bank conflict 的情况，说明这一行元素已经占满了完整的 bank 长度，也就是说会超过一个 phase 大小，从而避免 bank conflict</p> <h3 id=epilogue>Epilogue<a class=headerlink href=#epilogue title="Permanent link">¶</a></h3> <p>在计算完成后，我们需要将累加器（寄存器）中的结果，全部都运输到 global memory 当中存储起来。但直接完成这件事并不是最优选项，因为会造成不连续的数据写入（如下图），这样会导致存储时需要更多的内存事务，而不能使用向量化存储指令（STG.128）</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/v2-ddece7971d1161bbf7c7fa8022859993_1440w.jpg data-desc-position=bottom><img src=CUDA%20Programming%208.1/v2-ddece7971d1161bbf7c7fa8022859993_1440w.jpg alt=img style="zoom: 50%;"></a></p> <p>针对这个问题，cute 中专门提供了 Epilogue 来通过共享内存作为中间媒介。先将寄存器数据存储到共享内存，然后再从共享内存中以更连续、更高位宽的形式存储到全局内存中去。对于 half 元素来说应该至少让一行有 8 个元素进行运输，这样就能用 128bit 的向量化存储指令了</p> <h2 id=hgemm>hgemm 实践<a class=headerlink href=#hgemm title="Permanent link">¶</a></h2> <p>我在之前的笔记中提出了一个：tile centric CUDA programming 的思路，在这一小节中我将沿着这个核心思路，并进行更详细地拓展，利用这些思想解决高性能 hgemm kernel。这些思路也是借鉴了 tilelang 的 <a href="https://github.com/tile-ai/tilelang?tab=readme-ov-file#gemm-example-with-annotations-layout-l2-cache-swizzling-and-pipelining-etc">demo</a></p> <p>在此我提出一个 2-level tile 的概念：</p> <ol> <li>first-level: CTA Tile。作为最高 level 的 tile，该 level 非常方便我们设计宏观的 pipeline，e.g.: multi-stage or producer-consumer pipeline</li> <li>second-level tile 会有许多种，其核心是具体解决 CTA tile 的各阶段问题，包含：各个阶段的 cta tile copy；计算 cta tile mma</li> </ol> <p>tilelang 将专注于 first-level tile programming，把 pipeline 和 second level tile 问题都自动解决了，这给我们设计 kernel 带来了极大的便利，这必定是以后的大趋势。不过在此我们仍然要讨论清楚这些细节</p> <ul> <li>可以从不同的 level 来设计流水线：from cta tile level to second-tile level，pipeline inside of a pipeline</li> </ul> <h3 id=define-tile>Define tile<a class=headerlink href=#define-tile title="Permanent link">¶</a></h3> <p>我们以 tile 为 centric 作为构建模块，而 tile 的核心参考就是 mma shape。以 <code>SM80_16x8x16_F16F16F16F16_TN</code> 作为 mma op，其 mnk shape 为 <code>(16, 8, 16)</code>，我们以此为基础推理出合理的 tile 设置。为了方便讨论，我们把条件设置更具体一些：使用 4 个 warps，以 <code>(2, 2)</code> 的 layout 进行排列</p> <ol> <li>mma mnk tile 的大小将从单个 warp 的形状 <code>(16, 8, 16)</code> 扩展为 4 个 warp 的形状 <code>(32, 16, 16)</code></li> <li>g2s tile，一定要使用向量化读写，每一个 thread 将对应 128-bit 数据（i.e. 8 个 fp16），128 个线程则能够复制 1024 个 fp16 数据，我们可以构建一个 <code>(32, 32)</code> 的 tile</li> <li>s2r tile，需要满足 mma 的特殊 tv 要求，同时满足 ldsm 命令的合法性（size of v 必须为 8），我们需要在 mma shape 的 N 维度上进行扩展，构建出 <code>(32, 32, 16)</code> 的 tile，为什么要扩展两倍，请参考 TiledMMA &amp; ldmatrix 小节</li> <li>r2s tile，可以使用 <code>(32, 32)</code> 的 tile，注意由于 register 的特殊排布，无法使用 128-bit 的向量化读写</li> <li>s2g tile，可以使用 <code>(32, 32)</code> 的 tile，使用高效的向量化读写</li> </ol> <p>以上是 second-level tile 的设置，对于 cta mnk tile 的设置我们可以设置为 <code>(128, 128, 32)</code>，其中有两个参考理由：</p> <ol> <li>我们需要较大的 cta tile size 来增加计算时间，从而掩藏 copy 时间</li> <li>需要使用 double buffer，所以扩大了 k 方向大小</li> </ol> <h3 id=define-smem>Define smem<a class=headerlink href=#define-smem title="Permanent link">¶</a></h3> <p>在 gemm 算法中定义 shared memory 主要从 3 个方面来考量：</p> <ol> <li>定义一个 block 需要处理的 Tiler MN shape（区别于 tiled mma mn shape）</li> <li>定义 shared memory 流水线 stages</li> <li>定义 register 流水线 stages</li> </ol> <p>在 hgemm 实践中我们定义为如下：</p> <ol> <li>一个 block 需要处理 <code>(128, 128)</code> 区域的 MN 矩阵乘法（Matrix C view）</li> <li>shared memory 流水线为 3 级</li> <li>register 流水线为 2 级</li> </ol> <p>根据以上定义我们可以计算得到所需要的 shared memory 大小以及 swizzle</p> <ol> <li>matrix A &amp; B 各需要 <code>(128, 32, 3)</code> 大小的 shared memory，其中 <code>32 = 16 * 2</code> 代表了 register 的两级流水线，会在小 k 循环中进行 2 次。最后一个维度 <code>3</code> 则代表了 shared memory 的 3 级流水线</li> <li>matrix C 并不需要全部存储到 shared memory 当中，shared memory 只是作为一个中转站以方便进行向量化读取，所以需要 <code>(32, 32)</code> 大小即可，在 reed 所给代码中使用了 <code>(32, 32, 2)</code> 的大小，相当于申请了更大的 shared memory 作为中转，但在我的实验过程中发现加速效果不明显</li> <li>根据之前的 swizzle 计算思路，我们只讨论一个 phase 当中的 shared memory 读取，也就是 <code>(8, 32)</code> 大小的 shared memory 读取。那么利用公式可以得到 <code>Swizzle&lt;B=2, S=3, M=3&gt;</code>，而在 reed 所给代码中则使用了 <code>Swizzle&lt;B=3, S=3, M=3&gt;</code> 其能够处理更大范围的 bank conflict</li> </ol> <h3 id=pipelines>Pipelines<a class=headerlink href=#pipelines title="Permanent link">¶</a></h3> <p>在之前我只是对 reed multi-stage pipeline 进行了简单的描述。可是要自己构建一个流水线应该如何做到？其实流水线的核心非常简单，就是任务重叠，具体到 GPU model 当中就是数据搬运与计算的重叠。最简单有效的 pipeline 就是 double buffer pipeline，可以用下图表示，横向为时间</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20251110150608284.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20251110150608284.png alt=image-20251110150608284 style=zoom:67%;></a></p> <p>在重叠二者的编程中，有2个关键的要素：</p> <ol> <li><strong>在计算当前 data MMA 时，同时预取下一个 data</strong></li> <li><strong>在计算当前 data MMA 时，必须确保当前 data 填充完毕</strong></li> </ol> <p>在具体实现时还有一些细节，例如计算 buffer index，以及在循环正式开始之前需要做的前置操作（e.g. 0-data load）等等。如果把 double buffer 进行扩展，有多个 buffer（也被称为 multi-stage），可以用下图表示</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20251110170235632.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20251110170235632.png alt=image-20251110170235632 style=zoom:67%;></a></p> <p>以上展示了一个 4 buffer 的流水线过程。我们先预先发起 3 个 buffer 的数据搬运，在真实计算 MMA 0 的时候发起最后一个 buffer 的数据预取，这能够让我们预取更多的数据。我认为这并不是典型的 producer-consumer model，因为 producer 并不是持续地在进行搬运数据，而是在当前 MMA 计算时，同时去预取了下一个 data</p> <p>在上图中 MMA 直接从 shared memory 中获得数据开始计算了，实际上在 sm80 架构上 MMA 需要从 register 获得数据进行计算。所以有一个 smem -&gt; register 的数据搬运过程。这个过程也可以用 double buffer 的思路进行流水线并行，所以两个流水线构成了 pipeline in the pipeline。两个 pipeline 会有数据上的依赖性，具体来说 register pipeline 中要求对应的 shared memory 必须完成 copy，这一点需要在编程中显示确认。下图展示了一个 double register buffer 的 pipeline 示意图，每两个 register 将消耗一批 smem buffer，每两个 MMA 计算完成一批数据</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=CUDA%20Programming%208.1/image-20251110173829549.png data-desc-position=bottom><img src=CUDA%20Programming%208.1/image-20251110173829549.png alt=image-20251110173829549 style=zoom:67%;></a></p> <p>在实现过程中，我们可以逐层地实现 pipeline，把第 0 批的数据先预取好，然后直接开启 pipeline 循环。对于 epilogue 似乎没有使用 pipeline，可以直接按照常规的方案逐 tile 进行 regsiter -&gt; smem -&gt; gmem 搬运</p> <h3 id=pseudo-code>Pseudo code<a class=headerlink href=#pseudo-code title="Permanent link">¶</a></h3> <p>问题定义与上述相同：解决 <code>MNK = (4096, 4096, 1024)</code> 矩阵乘，CTA Tile 为 <code>(128, 128, 32)</code>，CTA threads 为 128，warp layout <code>(2, 2)</code>，smem 有 3 个 stages</p> <div class="language-cpp highlight"><span class=filename>C++</span><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1></a><a href=#__codelineno-45-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// CTATile_MNK = (128, 128, 32)</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2></a><a href=#__codelineno-45-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1>// gA (CTATile_M, CTATile_K, num_k)</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3></a><a href=#__codelineno-45-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1>// gB (CTATile_N, CTATile_K, num_k)</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4></a><a href=#__codelineno-45-4><span class=linenos data-linenos=" 4 "></span></a><span class=c1>// gC (CTATile_M, CTATile_N)</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5></a><a href=#__codelineno-45-5><span class=linenos data-linenos=" 5 "></span></a><span class=c1>// sA (CTATile_M, CTATile_K, stages)</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6></a><a href=#__codelineno-45-6><span class=linenos data-linenos=" 6 "></span></a><span class=c1>// sB (CTATile_N, CTATile_K, stages)</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7></a><a href=#__codelineno-45-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8></a><a href=#__codelineno-45-8><span class=linenos data-linenos=" 8 "></span></a><span class=c1>// tiled_mma (32, 16, 16)</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9></a><a href=#__codelineno-45-9><span class=linenos data-linenos=" 9 "></span></a><span class=c1>// tiled_g2s (32, 32)</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10></a><a href=#__codelineno-45-10><span class=linenos data-linenos="10 "></span></a><span class=c1>// tiled_s2r (32, 32, 16)</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11></a><a href=#__codelineno-45-11><span class=linenos data-linenos="11 "></span></a><span class=c1>// tiled_r2s (32, 32)</span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12></a><a href=#__codelineno-45-12><span class=linenos data-linenos="12 "></span></a><span class=c1>// tiled_s2g (32, 32)</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13></a><a href=#__codelineno-45-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-45-14><a id=__codelineno-45-14 name=__codelineno-45-14></a><a href=#__codelineno-45-14><span class=linenos data-linenos="14 "></span></a><span class=c1>// register allocation</span>
</span><span id=__span-45-15><a id=__codelineno-45-15 name=__codelineno-45-15></a><a href=#__codelineno-45-15><span class=linenos data-linenos="15 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>threadIdx</span><span class=p>.</span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-45-16><a id=__codelineno-45-16 name=__codelineno-45-16></a><a href=#__codelineno-45-16><span class=linenos data-linenos="16 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>thr_mma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_mma</span><span class=p>.</span><span class=n>get_slice</span><span class=p>(</span><span class=n>idx</span><span class=p>);</span><span class=w> </span>
</span><span id=__span-45-17><a id=__codelineno-45-17 name=__codelineno-45-17></a><a href=#__codelineno-45-17><span class=linenos data-linenos="17 "></span></a><span class=n>t_rA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thr_mma</span><span class=p>.</span><span class=n>partition_fragment_A</span><span class=p>(</span><span class=n>gA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w> </span><span class=c1>// (8, 128/32, 32/16)</span>
</span><span id=__span-45-18><a id=__codelineno-45-18 name=__codelineno-45-18></a><a href=#__codelineno-45-18><span class=linenos data-linenos="18 "></span></a><span class=n>t_rB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thr_mma</span><span class=p>.</span><span class=n>partition_fragment_B</span><span class=p>(</span><span class=n>gB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w> </span><span class=c1>// (4, 128/16, 32/16)</span>
</span><span id=__span-45-19><a id=__codelineno-45-19 name=__codelineno-45-19></a><a href=#__codelineno-45-19><span class=linenos data-linenos="19 "></span></a><span class=n>t_rC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thr_mma</span><span class=p>.</span><span class=n>partition_fragment_C</span><span class=p>(</span><span class=n>gC</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>));</span><span class=w> </span><span class=c1>// (8, 128/32, 128/16)</span>
</span><span id=__span-45-20><a id=__codelineno-45-20 name=__codelineno-45-20></a><a href=#__codelineno-45-20><span class=linenos data-linenos="20 "></span></a><span class=n>clear</span><span class=p>(</span><span class=n>t_rC</span><span class=p>);</span>
</span><span id=__span-45-21><a id=__codelineno-45-21 name=__codelineno-45-21></a><a href=#__codelineno-45-21><span class=linenos data-linenos="21 "></span></a>
</span><span id=__span-45-22><a id=__codelineno-45-22 name=__codelineno-45-22></a><a href=#__codelineno-45-22><span class=linenos data-linenos="22 "></span></a><span class=c1>// g2s copy partition</span>
</span><span id=__span-45-23><a id=__codelineno-45-23 name=__codelineno-45-23></a><a href=#__codelineno-45-23><span class=linenos data-linenos="23 "></span></a><span class=n>t_g2s_gA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_g2s</span><span class=p>.</span><span class=n>partition_S</span><span class=p>(</span><span class=n>gA</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 128/32, 32/32, num_k)</span>
</span><span id=__span-45-24><a id=__codelineno-45-24 name=__codelineno-45-24></a><a href=#__codelineno-45-24><span class=linenos data-linenos="24 "></span></a><span class=n>t_g2s_sA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_g2s</span><span class=p>.</span><span class=n>partition_D</span><span class=p>(</span><span class=n>sA</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 1, stages)</span>
</span><span id=__span-45-25><a id=__codelineno-45-25 name=__codelineno-45-25></a><a href=#__codelineno-45-25><span class=linenos data-linenos="25 "></span></a><span class=n>t_g2s_gB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_g2s</span><span class=p>.</span><span class=n>partition_S</span><span class=p>(</span><span class=n>gB</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 1, num_k)</span>
</span><span id=__span-45-26><a id=__codelineno-45-26 name=__codelineno-45-26></a><a href=#__codelineno-45-26><span class=linenos data-linenos="26 "></span></a><span class=n>t_g2s_sA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_g2s</span><span class=p>.</span><span class=n>partition_D</span><span class=p>(</span><span class=n>sB</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 1, stages)</span>
</span><span id=__span-45-27><a id=__codelineno-45-27 name=__codelineno-45-27></a><a href=#__codelineno-45-27><span class=linenos data-linenos="27 "></span></a>
</span><span id=__span-45-28><a id=__codelineno-45-28 name=__codelineno-45-28></a><a href=#__codelineno-45-28><span class=linenos data-linenos="28 "></span></a><span class=c1>// s2r copy partition</span>
</span><span id=__span-45-29><a id=__codelineno-45-29 name=__codelineno-45-29></a><a href=#__codelineno-45-29><span class=linenos data-linenos="29 "></span></a><span class=n>t_s2r_sA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_s2r_A</span><span class=p>.</span><span class=n>partition</span><span class=p>(</span><span class=n>sA</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 2, stages)</span>
</span><span id=__span-45-30><a id=__codelineno-45-30 name=__codelineno-45-30></a><a href=#__codelineno-45-30><span class=linenos data-linenos="30 "></span></a><span class=n>t_s2r_rA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_s2r_A</span><span class=p>.</span><span class=n>retile_D</span><span class=p>(</span><span class=n>t_rA</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 2)</span>
</span><span id=__span-45-31><a id=__codelineno-45-31 name=__codelineno-45-31></a><a href=#__codelineno-45-31><span class=linenos data-linenos="31 "></span></a><span class=n>t_s2r_sB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_s2r_B</span><span class=p>.</span><span class=n>partition</span><span class=p>(</span><span class=n>sB</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 2, stages)</span>
</span><span id=__span-45-32><a id=__codelineno-45-32 name=__codelineno-45-32></a><a href=#__codelineno-45-32><span class=linenos data-linenos="32 "></span></a><span class=n>t_s2r_rB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tiled_s2r_B</span><span class=p>.</span><span class=n>retile_D</span><span class=p>(</span><span class=n>t_rB</span><span class=p>);</span><span class=w> </span><span class=c1>// (8, 4, 2)</span>
</span><span id=__span-45-33><a id=__codelineno-45-33 name=__codelineno-45-33></a><a href=#__codelineno-45-33><span class=linenos data-linenos="33 "></span></a>
</span><span id=__span-45-34><a id=__codelineno-45-34 name=__codelineno-45-34></a><a href=#__codelineno-45-34><span class=linenos data-linenos="34 "></span></a><span class=c1>// prepare before mainloop</span>
</span><span id=__span-45-35><a id=__codelineno-45-35 name=__codelineno-45-35></a><a href=#__codelineno-45-35><span class=linenos data-linenos="35 "></span></a><span class=c1>// 1. launch the stages - 1 copy</span>
</span><span id=__span-45-36><a id=__codelineno-45-36 name=__codelineno-45-36></a><a href=#__codelineno-45-36><span class=linenos data-linenos="36 "></span></a><span class=c1>// 2. launch s2r first small iter k copy</span>
</span><span id=__span-45-37><a id=__codelineno-45-37 name=__codelineno-45-37></a><a href=#__codelineno-45-37><span class=linenos data-linenos="37 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>load_tile_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-45-38><a id=__codelineno-45-38 name=__codelineno-45-38></a><a href=#__codelineno-45-38><span class=linenos data-linenos="38 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>mma_tile_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-45-39><a id=__codelineno-45-39 name=__codelineno-45-39></a><a href=#__codelineno-45-39><span class=linenos data-linenos="39 "></span></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>istage</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>istage</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>stages</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>istage</span><span class=o>++</span><span class=p>){</span>
</span><span id=__span-45-40><a id=__codelineno-45-40 name=__codelineno-45-40></a><a href=#__codelineno-45-40><span class=linenos data-linenos="40 "></span></a><span class=w>    </span><span class=n>copy</span><span class=p>(</span><span class=n>tiled_g2s</span><span class=p>,</span><span class=w> </span><span class=n>t_g2s_gA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>istage</span><span class=p>),</span><span class=w> </span><span class=n>t_g2s_sA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>istage</span><span class=p>));</span>
</span><span id=__span-45-41><a id=__codelineno-45-41 name=__codelineno-45-41></a><a href=#__codelineno-45-41><span class=linenos data-linenos="41 "></span></a><span class=w>    </span><span class=n>copy</span><span class=p>(</span><span class=n>tiled_g2s</span><span class=p>,</span><span class=w> </span><span class=n>t_g2s_gB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>istage</span><span class=p>),</span><span class=w> </span><span class=n>t_g2s_sB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>istage</span><span class=p>));</span>
</span><span id=__span-45-42><a id=__codelineno-45-42 name=__codelineno-45-42></a><a href=#__codelineno-45-42><span class=linenos data-linenos="42 "></span></a><span class=w>    </span><span class=n>cp_async_fence</span><span class=p>();</span><span class=w> </span><span class=c1>// commit</span>
</span><span id=__span-45-43><a id=__codelineno-45-43 name=__codelineno-45-43></a><a href=#__codelineno-45-43><span class=linenos data-linenos="43 "></span></a><span class=w>    </span><span class=n>load_tile_idx</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-45-44><a id=__codelineno-45-44 name=__codelineno-45-44></a><a href=#__codelineno-45-44><span class=linenos data-linenos="44 "></span></a><span class=p>}</span>
</span><span id=__span-45-45><a id=__codelineno-45-45 name=__codelineno-45-45></a><a href=#__codelineno-45-45><span class=linenos data-linenos="45 "></span></a><span class=n>cp_async_wait</span><span class=o>&lt;</span><span class=n>stages</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>2</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-45-46><a id=__codelineno-45-46 name=__codelineno-45-46></a><a href=#__codelineno-45-46><span class=linenos data-linenos="46 "></span></a><span class=n>__syncthreads</span><span class=p>();</span>
</span><span id=__span-45-47><a id=__codelineno-45-47 name=__codelineno-45-47></a><a href=#__codelineno-45-47><span class=linenos data-linenos="47 "></span></a><span class=n>copy</span><span class=p>(</span><span class=n>tiled_s2r_A</span><span class=p>,</span><span class=w> </span><span class=n>t_s2r_sA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>t_s2r_rA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-45-48><a id=__codelineno-45-48 name=__codelineno-45-48></a><a href=#__codelineno-45-48><span class=linenos data-linenos="48 "></span></a><span class=n>copy</span><span class=p>(</span><span class=n>tiled_s2r_B</span><span class=p>,</span><span class=w> </span><span class=n>t_s2r_sB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>t_s2r_rB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-45-49><a id=__codelineno-45-49 name=__codelineno-45-49></a><a href=#__codelineno-45-49><span class=linenos data-linenos="49 "></span></a>
</span><span id=__span-45-50><a id=__codelineno-45-50 name=__codelineno-45-50></a><a href=#__codelineno-45-50><span class=linenos data-linenos="50 "></span></a><span class=c1>// mainloop</span>
</span><span id=__span-45-51><a id=__codelineno-45-51 name=__codelineno-45-51></a><a href=#__codelineno-45-51><span class=linenos data-linenos="51 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>num_k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=o>&lt;</span><span class=mi>3</span><span class=o>&gt;</span><span class=p>(</span><span class=n>t_g2s_gA</span><span class=p>);</span>
</span><span id=__span-45-52><a id=__codelineno-45-52 name=__codelineno-45-52></a><a href=#__codelineno-45-52><span class=linenos data-linenos="52 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>num_k_inner</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=o>&lt;</span><span class=mi>2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>t_s2r_rA</span><span class=p>);</span>
</span><span id=__span-45-53><a id=__codelineno-45-53 name=__codelineno-45-53></a><a href=#__codelineno-45-53><span class=linenos data-linenos="53 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>buffer_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-45-54><a id=__codelineno-45-54 name=__codelineno-45-54></a><a href=#__codelineno-45-54><span class=linenos data-linenos="54 "></span></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>itile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>itile</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>num_big_k</span><span class=p>;</span><span class=w> </span><span class=n>itile</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-55><a id=__codelineno-45-55 name=__codelineno-45-55></a><a href=#__codelineno-45-55><span class=linenos data-linenos="55 "></span></a><span class=w>    </span><span class=c1>// load next k tile</span>
</span><span id=__span-45-56><a id=__codelineno-45-56 name=__codelineno-45-56></a><a href=#__codelineno-45-56><span class=linenos data-linenos="56 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>load_tile_idx</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>num_k</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-57><a id=__codelineno-45-57 name=__codelineno-45-57></a><a href=#__codelineno-45-57><span class=linenos data-linenos="57 "></span></a><span class=w>        </span><span class=n>buffer_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>load_tile_idx</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>stages</span><span class=p>;</span>
</span><span id=__span-45-58><a id=__codelineno-45-58 name=__codelineno-45-58></a><a href=#__codelineno-45-58><span class=linenos data-linenos="58 "></span></a><span class=w>        </span><span class=n>copy</span><span class=p>(</span><span class=n>tiled_g2s</span><span class=p>,</span><span class=w> </span><span class=n>t_g2s_gA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>load_tile_idx</span><span class=p>),</span><span class=w> </span><span class=n>t_g2s_sA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>buffer_idx</span><span class=p>));</span>
</span><span id=__span-45-59><a id=__codelineno-45-59 name=__codelineno-45-59></a><a href=#__codelineno-45-59><span class=linenos data-linenos="59 "></span></a><span class=w>        </span><span class=n>copy</span><span class=p>(</span><span class=n>tiled_g2s</span><span class=p>,</span><span class=w> </span><span class=n>t_g2s_gB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>load_tile_idx</span><span class=p>),</span><span class=w> </span><span class=n>t_g2s_sB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>buffer_idx</span><span class=p>));</span>
</span><span id=__span-45-60><a id=__codelineno-45-60 name=__codelineno-45-60></a><a href=#__codelineno-45-60><span class=linenos data-linenos="60 "></span></a><span class=w>        </span><span class=n>load_tile_idx</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-45-61><a id=__codelineno-45-61 name=__codelineno-45-61></a><a href=#__codelineno-45-61><span class=linenos data-linenos="61 "></span></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-62><a id=__codelineno-45-62 name=__codelineno-45-62></a><a href=#__codelineno-45-62><span class=linenos data-linenos="62 "></span></a><span class=w>    </span><span class=n>cp_async_fence</span><span class=p>();</span>
</span><span id=__span-45-63><a id=__codelineno-45-63 name=__codelineno-45-63></a><a href=#__codelineno-45-63><span class=linenos data-linenos="63 "></span></a>
</span><span id=__span-45-64><a id=__codelineno-45-64 name=__codelineno-45-64></a><a href=#__codelineno-45-64><span class=linenos data-linenos="64 "></span></a><span class=w>    </span><span class=c1>// small k iteration</span>
</span><span id=__span-45-65><a id=__codelineno-45-65 name=__codelineno-45-65></a><a href=#__codelineno-45-65><span class=linenos data-linenos="65 "></span></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>ik</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>ik</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>num_k_inner</span><span class=p>;</span><span class=w> </span><span class=n>ik</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-66><a id=__codelineno-45-66 name=__codelineno-45-66></a><a href=#__codelineno-45-66><span class=linenos data-linenos="66 "></span></a><span class=w>        </span><span class=c1>// load next small k tile</span>
</span><span id=__span-45-67><a id=__codelineno-45-67 name=__codelineno-45-67></a><a href=#__codelineno-45-67><span class=linenos data-linenos="67 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ik</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>num_k_inner</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>){</span>
</span><span id=__span-45-68><a id=__codelineno-45-68 name=__codelineno-45-68></a><a href=#__codelineno-45-68><span class=linenos data-linenos="68 "></span></a><span class=w>            </span><span class=c1>// make sure the next k tile complete</span>
</span><span id=__span-45-69><a id=__codelineno-45-69 name=__codelineno-45-69></a><a href=#__codelineno-45-69><span class=linenos data-linenos="69 "></span></a><span class=w>            </span><span class=n>cp_async_wait</span><span class=o>&lt;</span><span class=n>stages</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>2</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-45-70><a id=__codelineno-45-70 name=__codelineno-45-70></a><a href=#__codelineno-45-70><span class=linenos data-linenos="70 "></span></a><span class=w>            </span><span class=n>__syncthreads</span><span class=p>();</span>
</span><span id=__span-45-71><a id=__codelineno-45-71 name=__codelineno-45-71></a><a href=#__codelineno-45-71><span class=linenos data-linenos="71 "></span></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-45-72><a id=__codelineno-45-72 name=__codelineno-45-72></a><a href=#__codelineno-45-72><span class=linenos data-linenos="72 "></span></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ik_next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ik</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>num_k_inner</span>
</span><span id=__span-45-73><a id=__codelineno-45-73 name=__codelineno-45-73></a><a href=#__codelineno-45-73><span class=linenos data-linenos="73 "></span></a><span class=w>        </span><span class=c1>// calculate read tile</span>
</span><span id=__span-45-74><a id=__codelineno-45-74 name=__codelineno-45-74></a><a href=#__codelineno-45-74><span class=linenos data-linenos="74 "></span></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>read_stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ik</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>num_k_iker</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>itle</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>stages</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=n>itile</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>stages</span>
</span><span id=__span-45-75><a id=__codelineno-45-75 name=__codelineno-45-75></a><a href=#__codelineno-45-75><span class=linenos data-linenos="75 "></span></a><span class=w>        </span><span class=n>copy</span><span class=p>(</span><span class=n>tiled_s2r_A</span><span class=p>,</span><span class=w> </span><span class=n>t_s2r_sA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>ik_next</span><span class=p>,</span><span class=w> </span><span class=n>read_stage</span><span class=p>),</span><span class=w> </span><span class=n>t_s2r_rA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>ik_next</span><span class=p>));</span>
</span><span id=__span-45-76><a id=__codelineno-45-76 name=__codelineno-45-76></a><a href=#__codelineno-45-76><span class=linenos data-linenos="76 "></span></a><span class=w>        </span><span class=n>copy</span><span class=p>(</span><span class=n>tiled_s2r_B</span><span class=p>,</span><span class=w> </span><span class=n>t_s2r_sB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>ik_next</span><span class=p>,</span><span class=w> </span><span class=n>read_stage</span><span class=p>),</span><span class=w> </span><span class=n>t_s2r_rB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>ik_next</span><span class=p>));</span>
</span><span id=__span-45-77><a id=__codelineno-45-77 name=__codelineno-45-77></a><a href=#__codelineno-45-77><span class=linenos data-linenos="77 "></span></a>
</span><span id=__span-45-78><a id=__codelineno-45-78 name=__codelineno-45-78></a><a href=#__codelineno-45-78><span class=linenos data-linenos="78 "></span></a><span class=w>        </span><span class=c1>// gemm</span>
</span><span id=__span-45-79><a id=__codelineno-45-79 name=__codelineno-45-79></a><a href=#__codelineno-45-79><span class=linenos data-linenos="79 "></span></a><span class=w>        </span><span class=n>gemm</span><span class=p>(</span><span class=n>tiled_mma</span><span class=p>,</span><span class=w> </span><span class=n>t_rC</span><span class=p>,</span><span class=w> </span><span class=n>t_rA</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>ik</span><span class=p>),</span><span class=w> </span><span class=n>t_rB</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>ik</span><span class=p>),</span><span class=w> </span><span class=n>t_rC</span><span class=p>);</span>
</span><span id=__span-45-80><a id=__codelineno-45-80 name=__codelineno-45-80></a><a href=#__codelineno-45-80><span class=linenos data-linenos="80 "></span></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-81><a id=__codelineno-45-81 name=__codelineno-45-81></a><a href=#__codelineno-45-81><span class=linenos data-linenos="81 "></span></a><span class=p>}</span>
</span></code></pre></div> <p>可以看到大量代码其实不是在 mainloop 当中，而是在资源申请和数据切分，本身流水线还是非常清晰！</p> <h2 id=_7>总结<a class=headerlink href=#_7 title="Permanent link">¶</a></h2> <p>如何学习一个陌生且没有那么多资料的领域？</p> <p>一些描述对于我来说或许非常抽象：数学公式，C++...但实际上这些都是非常清晰的描述，如果转换成为 python 或者我熟悉的语言描述我就能很好地理解。而这个过程恰好是 GPT 比较擅长的：因为 GPT 对这些语言都非常熟悉，将一个语言翻译为另外一种语言基本上不在话下，只要所提供的描述是准确且基础的，通过切入到我所熟悉的语言，那么理解起来就事半功倍了。但是如果所问的问题是一个没有太多资料的复杂领域：例如 layout algebra，如果不提供基础的数学证明材料，很难获得一个让我满意的回答，我也无法完成对问题的解决</p> <p>在学习 cutlass 的路上 Grok &amp; DeepSeek 给与了很大的帮助，可以具体看下其解决了哪些疑问</p> <ol> <li> <p>Layout Algebra python scripts</p> <p>利用原始数学证明材料写出了 layout algebra 各个基础运算的 python 代码。通过利用代码交互，能够更快地发现 layout algebra 中的一些性质</p> </li> <li> <p>Compose first impression: fit spots to memory，但不够本质</p> <p>对于 compose 的最终顿悟来源于对 right inverse 的理解，彻底理解了 compose 是“映射”，赋予映射的 source domain &amp; target domain 以含义具有重要意义</p> </li> <li> <p>Cutlass recasting</p> <p>利用清晰的 C++ 代码得出了 recast 的算法过程</p> </li> <li> <p>Swizzle Parameters</p> <p>利用 Lei Mao's blog 的清晰描述与定义，给出了 swizzle 例子的中间推导过程，理解 swizzle in bits 形式</p> </li> </ol> <p><strong>重大的突破其实来源于清晰的学习目标以及选择优秀的学习材料</strong>。我需要学习材料包含足够多的上下文以支持我去完成所指定的目标。上下文主要包含几点：1. 清晰的文档结构与教程；2. 足够简洁的原理代码；3. 准确的公式推导（与第一点有所重叠）</p> <p>三点钟任意满足一点就是不错的材料，满足两点就是非常优秀的材料。因为有了 GPT 的存在，对于不熟悉的领域可以“翻译”成为你所熟悉的语言，方便你进行理解：例如 c++ -&gt; python or math -&gt; python，并且可以通过构建最小例子来完成特例到通用的抽象化理解。所以拥有了好的学习材料，很大程度上就能保证学习的成功</p> <script src=https://giscus.app/client.js data-repo=declk/blog-comments data-repo-id=R_kgDOQiTEqg data-category=Announcements data-category-id=DIC_kwDOQiTEqs4CzYFN data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async>
</script> <!-- Synchronize Giscus theme with palette --> <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

        // Instruct Giscus to set theme
        giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function () {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function () {
            var palette = __md_get("__palette")
            if (palette && typeof palette.color === "object") {
                var theme = palette.color.scheme === "slate"
                    ? "transparent_dark"
                    : "light"

                // Instruct Giscus to change theme
                var frame = document.querySelector(".giscus-frame")
                frame.contentWindow.postMessage(
                    {giscus: {setConfig: {theme}}},
                    "https://giscus.app"
                )
            }
        })
    })
</script> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <!-- Application footer --> <footer class=md-footer> <!-- Link to previous and/or next page --> <!-- Website statistics --> <!-- 隐藏运行时间 --> <!-- <div class="md-footer-stats">
    <div class="md-footer-stats__inner md-grid">
      <div class="md-footer-stats__content">
        <span class="md-footer-stats__item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" style="vertical-align: middle; margin-right: 4px;">
            <path fill="currentColor" d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z" />
          </svg>
          <span>运行时间: <span id="web-time">加载中...</span></span>
        </span>
      </div>
    </div>
  </div> --> <!-- Further information --> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright © 2025 - Present <a href=https://github.com/declk/ target=_blank rel=noopener>DeclK</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <!-- Social links --> <div class=md-social> <a href=https://github.com/declk/ target=_blank rel=noopener title=GitHub class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a href=https://www.zhihu.com/people/DeclK target=_blank rel=noopener title=Zhihu class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M170.5 148.1v217.5h23.4l7.7 26.4 42-26.4h49.5V148.1H170.4zM268.3 342h-27.9l-27.9 17.5-5.1-17.5h-11.9V171.7h72.8zm-118.5-94.3H97.5c1.7-27.1 2.2-51.6 2.2-73.5h51.2s2-22.6-8.6-22.3H53.8c3.5-13.1 7.9-26.7 13.1-40.7 0 0-24.1 0-32.3 21.6-3.4 8.9-13.2 43.1-30.7 78.1 5.9-.6 25.4-1.2 36.8-22.2 2.1-5.9 2.5-6.7 5.1-14.5h28.9c0 10.5-1.2 66.9-1.7 73.4H20.7c-11.7 0-15.6 23.6-15.6 23.6h65.6c-4.4 49.9-28 91.9-70.8 125.1 20.5 5.9 40.9-.9 51-9.9 0 0 23-20.9 35.6-69.3l54 64.9s7.9-26.9-1.2-40c-7.6-8.9-28.1-33.1-36.8-41.8L87.9 312c4.4-14 7-27.6 7.9-40.7h61.6s-.1-23.6-7.6-23.6m412-1.6c20.8-25.6 45-58.6 45-58.6s-18.6-14.8-27.4-4.1c-6 8.2-36.8 48.2-36.8 48.2l19.2 14.4zm-150-59.1c-9-8.2-25.9 2.1-25.9 2.1s39.5 55 41.1 57.4l19.5-13.7s-25.7-37.6-34.7-45.9zM640 258.4c-19.8 0-130.9.9-131.1.9v-101q7.2 0 22.8-1.2c40.9-2.4 70.1-4 87.8-4.8 0 0 12.2-27.2-.6-33.4-3.1-1.2-23.2 4.6-23.2 4.6s-165.2 16.5-232.4 18c1.6 8.8 7.6 17.1 15.8 19.6 13.3 3.5 22.7 1.7 49.2.9 24.8-1.6 43.7-2.4 56.5-2.4v99.8H351.3s2.8 22.3 25.5 22.9h107.9v70.9c0 14-11.2 22-24.5 21.1-14.1.1-26.1-1.1-41.7-1.8 2 4 6.3 14.4 19.3 21.8 9.9 4.8 16.2 6.6 26 6.6 29.6 0 45.7-17.3 44.9-45.3v-73.3h122.4c9.7 0 8.7-23.8 8.7-23.8z"></path></svg> </a> <a href=mailto:1605224559@qq.com target=_blank rel=noopener title="send email to me!" class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M536.4-26.3c9.8-3.5 20.6-1 28 6.3s9.8 18.2 6.3 28l-178 496.9c-5 13.9-18.1 23.1-32.8 23.1-14.2 0-27-8.6-32.3-21.7l-64.2-158c-4.5-11-2.5-23.6 5.2-32.6l94.5-112.4c5.1-6.1 4.7-15-.9-20.6s-14.6-6-20.6-.9l-112.4 94.3c-9.1 7.6-21.6 9.6-32.6 5.2L38.1 216.8c-13.1-5.3-21.7-18.1-21.7-32.3 0-14.7 9.2-27.8 23.1-32.8z"></path></svg> </a> </div> </div> </div> </footer> <!-- Website running time counter script --> <script>
  function updateWebTime() {
    var startDate = new Date("2025/12/03 20:00:00");
    var now = new Date();
    var diff = now.getTime() - startDate.getTime();
    
    var days = Math.floor(diff / (1000 * 60 * 60 * 24));
    var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    var timeStr = days + " 天 " + hours + " 小时 " + minutes + " 分钟";
    
    var webTimeElement = document.getElementById("web-time");
    if (webTimeElement) {
      webTimeElement.textContent = timeStr;
    }
    
    setTimeout(updateWebTime, 60000); // 每分钟更新一次
  }
  
  // 页面加载完成后启动计时器
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", updateWebTime);
  } else {
    updateWebTime();
  }
  

</script> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "header.autohide", "navigation.tracking", "navigation.tabs", "navigation.top", "navigation.path", "navigation.indexes", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../assets/javascripts/bundle.e71a0d61.min.js></script> <script src=../js/mathjax_fix.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../assets/document_dates/tippy/popper.min.js></script> <script src=../assets/document_dates/tippy/tippy.umd.min.js></script> <script src=../assets/document_dates/core/default.config.js></script> <script src=../assets/document_dates/user.config.js></script> <script src=../assets/document_dates/core/utils.js></script> <script src=../assets/document_dates/core/core.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html><!-- Insert generated snippet here -->